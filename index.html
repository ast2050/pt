<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ComicFrame - Manga Photo Frame Maker</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #0a0a0a;
  --panel:   #111111;
  --card:    #1a1a1a;
  --card2:   #222222;
  --border:  #2d2d2d;
  --accent:  #f5c518;
  --accent2: #e6b800;
  --text:    #f0f0f0;
  --muted:   #888888;
  --danger:  #ff4444;
  --radius:  8px;
}

html, body {
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
}

/* ── Layout ── */
.app { display: flex; height: 100vh; overflow: hidden; }

.sidebar {
  width: 340px;
  min-width: 340px;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.preview-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  position: relative;
  overflow: hidden;
}

/* ── Sidebar header ── */
.sidebar-header {
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 26px;
  letter-spacing: 3px;
  color: var(--accent);
  line-height: 1;
}

.logo span {
  color: var(--muted);
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
  letter-spacing: 0;
  font-weight: 300;
  display: block;
  margin-top: 2px;
}

/* ── Scrollable sidebar body ── */
.sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 0 0 16px;
}
.sidebar-body::-webkit-scrollbar { width: 3px; }
.sidebar-body::-webkit-scrollbar-track { background: transparent; }
.sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ── Steps ── */
.step {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.step-label {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.step-num {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--card2);
  color: var(--muted);
  font-size: 11px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  border: 1px solid var(--border);
  transition: all 0.25s;
}
.step-num.active { background: var(--accent); color: #000; border-color: var(--accent); }

.step-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 15px;
  letter-spacing: 2px;
  color: var(--muted);
  transition: color 0.25s;
}
.step-title.active { color: var(--text); }

/* ── Upload zone ── */
.upload-zone {
  display: block;             /* label element needs this */
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 22px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  -webkit-user-select: none;
}
.upload-zone:hover,
.upload-zone.drag {
  border-color: var(--accent);
  background: rgba(245, 197, 24, 0.05);
}
/* The real file input: hidden but accessible */
#fileInput {
  display: none;
}
.upload-icon { font-size: 26px; margin-bottom: 6px; opacity: 0.4; pointer-events: none; }
.upload-text { color: var(--muted); font-size: 12px; line-height: 1.5; pointer-events: none; }
.upload-text strong { color: var(--text); display: block; margin-bottom: 3px; font-size: 13px; }

/* ── Mode toggle ── */
.mode-toggle {
  display: flex;
  background: var(--card);
  border-radius: var(--radius);
  padding: 3px;
  gap: 3px;
}
.mode-btn {
  flex: 1;
  padding: 7px 6px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--muted);
  font-size: 11px;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1.3;
  text-align: center;
}
.mode-btn.active { background: var(--accent); color: #000; font-weight: 600; }

/* ── Template grid ── */
.template-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.tmpl-card {
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--card);
}
.tmpl-card:hover { border-color: #555; }
.tmpl-card.active { border-color: var(--accent); background: rgba(245, 197, 24, 0.07); }

.tmpl-preview {
  width: 100%;
  aspect-ratio: 3 / 4;
  background: var(--card2);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 6px;
}
.tmpl-preview svg { width: 100%; height: 100%; }

.tmpl-name {
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  text-align: center;
  transition: color 0.2s;
}
.tmpl-card.active .tmpl-name { color: var(--accent); }

/* ── 3-button selector ── */
.tri-select {
  display: flex;
  background: var(--card);
  border-radius: var(--radius);
  padding: 3px;
  gap: 3px;
}
.tri-btn {
  flex: 1;
  padding: 6px 4px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--muted);
  font-size: 11px;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}
.tri-btn.active { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
.tri-btn:hover:not(.active) { color: var(--text); }

/* ── Field label ── */
.field-label {
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-bottom: 6px;
}

/* ── Thumbnails ── */
.thumb-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; min-height: 0; }
.thumb-item {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  object-fit: cover;
  border: 2px solid var(--border);
}
.thumb-clear {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  border: 2px dashed var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--muted);
  font-size: 18px;
  transition: all 0.2s;
}
.thumb-clear:hover { border-color: var(--danger); color: var(--danger); }

/* ── Export button ── */
.btn-export {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: var(--radius);
  background: var(--accent);
  color: #000;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 18px;
  letter-spacing: 3px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn-export:hover:not(:disabled) { background: var(--accent2); transform: translateY(-1px); }
.btn-export:active:not(:disabled) { transform: translateY(0); }
.btn-export:disabled { background: var(--card2); color: var(--muted); cursor: not-allowed; }

/* ── Quality select ── */
.quality-select {
  display: flex;
  background: var(--card);
  border-radius: var(--radius);
  padding: 3px;
  gap: 3px;
  margin-bottom: 10px;
}
.qual-btn {
  flex: 1;
  padding: 6px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--muted);
  font-size: 11px;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  line-height: 1.4;
}
.qual-btn.active { background: var(--card2); color: var(--text); border: 1px solid var(--border); }

/* ── Preview area ── */
.preview-label {
  font-family: 'Bebas Neue', sans-serif;
  letter-spacing: 3px;
  font-size: 12px;
  color: var(--muted);
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  pointer-events: none;
}

.canvas-wrap {
  position: relative;
  box-shadow: 0 0 60px rgba(0, 0, 0, 0.8), 0 0 0 1px var(--border);
}
#mainCanvas { display: block; cursor: crosshair; }

.drag-hint {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: var(--muted);
  background: rgba(10, 10, 10, 0.85);
  padding: 5px 14px;
  border-radius: 20px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s;
  white-space: nowrap;
}
.drag-hint.show { opacity: 1; }

.empty-state { text-align: center; color: var(--muted); }
.empty-state .big-icon { font-size: 52px; opacity: 0.15; margin-bottom: 14px; }
.empty-state p { font-size: 13px; line-height: 1.7; }
</style>
</head>
<body>
<div class="app">

  <!-- ════════════ SIDEBAR ════════════ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">ComicFrame<span>漫画フォトフレーム メーカー</span></div>
    </div>

    <div class="sidebar-body">

      <!-- STEP 1: Upload -->
      <div class="step">
        <div class="step-label">
          <div class="step-num active" id="sn1">1</div>
          <div class="step-title active">写真をロード</div>
        </div>

        <div class="field-label">配置モード</div>
        <div class="mode-toggle" style="margin-bottom:10px">
          <button class="mode-btn active" id="modeSplit"
                  onclick="setMode('split')">
            1枚を分割配置<br>
            <span style="font-size:10px;opacity:.7">（自動ぶった斬り）</span>
          </button>
          <button class="mode-btn" id="modeIndiv"
                  onclick="setMode('individual')">
            コマに別々の写真<br>
            <span style="font-size:10px;opacity:.7">（複数アップロード）</span>
          </button>
        </div>

        <!-- label[for=fileInput] = 標準的なアップロードパターン。クリックで確実にダイアログが開く -->
        <label class="upload-zone" id="uploadZone" for="fileInput">
          <div class="upload-icon">&#128194;</div>
          <div class="upload-text">
            <strong>クリックまたはドラッグで写真を追加</strong>
            JPG / PNG / WebP 対応
          </div>
        </label>
        <!-- input は label の外に配置し display:none で非表示 -->
        <input type="file" id="fileInput" accept="image/*">
        <div class="thumb-list" id="thumbList"></div>
      </div>

      <!-- STEP 2: Template -->
      <div class="step">
        <div class="step-label">
          <div class="step-num" id="sn2">2</div>
          <div class="step-title" id="st2">テンプレートを選ぶ</div>
        </div>
        <div class="template-grid">

          <div class="tmpl-card active" id="t4koma" onclick="setTemplate('4koma')">
            <div class="tmpl-preview">
              <svg viewBox="0 0 60 80" fill="none">
                <rect width="60" height="80" fill="#222"/>
                <rect x="3"  y="3"  width="54" height="17" fill="#444" rx="1"/>
                <rect x="3"  y="22" width="54" height="17" fill="#444" rx="1"/>
                <rect x="3"  y="41" width="54" height="17" fill="#444" rx="1"/>
                <rect x="3"  y="60" width="54" height="17" fill="#444" rx="1"/>
              </svg>
            </div>
            <div class="tmpl-name">4コマ型</div>
          </div>

          <div class="tmpl-card" id="tdramatic" onclick="setTemplate('dramatic')">
            <div class="tmpl-preview">
              <svg viewBox="0 0 60 80" fill="none">
                <rect width="60" height="80" fill="#222"/>
                <rect x="3"  y="3"  width="54" height="35" fill="#444" rx="1"/>
                <rect x="3"  y="41" width="25" height="36" fill="#444" rx="1"/>
                <rect x="32" y="41" width="25" height="36" fill="#444" rx="1"/>
              </svg>
            </div>
            <div class="tmpl-name">ドラマチック型</div>
          </div>

          <div class="tmpl-card" id="tmagazine" onclick="setTemplate('magazine')">
            <div class="tmpl-preview">
              <svg viewBox="0 0 60 80" fill="none">
                <rect width="60" height="80" fill="#222"/>
                <rect x="3"  y="3"  width="54" height="74" fill="#444" rx="1"/>
                <rect x="34" y="52" width="20" height="22" fill="#555"
                      stroke="#f5c518" stroke-width="1.5" rx="1"/>
              </svg>
            </div>
            <div class="tmpl-name">雑誌表紙風</div>
          </div>

          <div class="tmpl-card" id="tspread" onclick="setTemplate('spread')">
            <div class="tmpl-preview">
              <svg viewBox="0 0 80 60" fill="none">
                <rect width="80" height="60" fill="#222"/>
                <rect x="3"  y="3" width="35" height="54" fill="#444" rx="1"/>
                <rect x="42" y="3" width="35" height="54" fill="#444" rx="1"/>
              </svg>
            </div>
            <div class="tmpl-name">見開き分割型</div>
          </div>

        </div>
      </div>

      <!-- STEP 3: Frame Style -->
      <div class="step">
        <div class="step-label">
          <div class="step-num" id="sn3">3</div>
          <div class="step-title" id="st3">フレームを設定</div>
        </div>

        <div class="field-label" style="margin-bottom:6px">枠線の太さ</div>
        <div class="tri-select" style="margin-bottom:12px">
          <button class="tri-btn active" id="bw-thin"  onclick="setBorder('thin')">細い (2px)</button>
          <button class="tri-btn"        id="bw-mid"   onclick="setBorder('mid')">中 (5px)</button>
          <button class="tri-btn"        id="bw-thick" onclick="setBorder('thick')">太い (10px)</button>
        </div>

        <div class="field-label" style="margin-bottom:6px">コマ間の余白（ドブ）</div>
        <div class="tri-select">
          <button class="tri-btn active" id="gap-none" onclick="setGap('none')">なし</button>
          <button class="tri-btn"        id="gap-mid"  onclick="setGap('mid')">中 (8px)</button>
          <button class="tri-btn"        id="gap-wide" onclick="setGap('wide')">広い (18px)</button>
        </div>
      </div>

      <!-- STEP 4: Export -->
      <div class="step">
        <div class="step-label">
          <div class="step-num" id="sn4">4</div>
          <div class="step-title" id="st4">書き出し・保存</div>
        </div>

        <div class="field-label" style="margin-bottom:6px">書き出し画質</div>
        <div class="quality-select">
          <button class="qual-btn active" id="q-standard" onclick="setQuality('standard')">
            SNS用（標準）<br><span style="font-size:9px;opacity:.7">1× 解像度</span>
          </button>
          <button class="qual-btn" id="q-high" onclick="setQuality('high')">
            鑑賞用（高画質）<br><span style="font-size:9px;opacity:.7">3× 解像度</span>
          </button>
        </div>

        <button class="btn-export" id="exportBtn" onclick="exportImage()" disabled>
          &#11015; 保存する
        </button>
        <div style="margin-top:8px;font-size:11px;color:var(--muted);text-align:center">
          PNG形式でダウンロードされます
        </div>
      </div>

    </div><!-- /sidebar-body -->
  </aside><!-- /sidebar -->

  <!-- ════════════ PREVIEW ════════════ -->
  <main class="preview-area" id="previewArea">
    <div class="preview-label">PREVIEW</div>

    <div id="emptyState" class="empty-state">
      <div class="big-icon">&#127902;</div>
      <p>写真をアップロードすると<br>プレビューが表示されます</p>
    </div>

    <div class="canvas-wrap" id="canvasWrap" style="display:none">
      <canvas id="mainCanvas"></canvas>
    </div>

    <div class="drag-hint" id="dragHint">ドラッグで写真の位置を調整できます</div>
  </main>

</div><!-- /app -->

<script>
/* ===================================================================
   STATE
=================================================================== */
var S = {
  mode:        'split',
  template:    '4koma',
  images:      [],        // Array<HTMLImageElement>
  cellOffsets: [],        // Array<{x:number, y:number}>
  dragging:    -1,
  dragStart:   { x: 0, y: 0 },
  dragOffset:  { x: 0, y: 0 },
  borderKey:   'thin',
  gapKey:      'none',
  quality:     'standard',
  hintShown:   false
};

var BORDER_MAP  = { thin: 2, mid: 5, thick: 10 };
var GAP_MAP     = { none: 0, mid: 8, wide: 18 };
var QUALITY_MAP = { standard: 1, high: 3 };
var BASE_H      = 900;

/* -------------------------------------------------------------------
   Template definitions
   All cell coords are normalized (0..1) relative to canvas w/h
------------------------------------------------------------------- */
var TEMPLATES = {
  '4koma': {
    aspect: 0.60,
    getCells: function() {
      return [
        { x: 0, y: 0.00, w: 1, h: 0.25 },
        { x: 0, y: 0.25, w: 1, h: 0.25 },
        { x: 0, y: 0.50, w: 1, h: 0.25 },
        { x: 0, y: 0.75, w: 1, h: 0.25 }
      ];
    },
    overlay: [false, false, false, false]
  },
  'dramatic': {
    aspect: 0.80,
    getCells: function() {
      return [
        { x: 0.0, y: 0.0, w: 1.0, h: 0.5 },
        { x: 0.0, y: 0.5, w: 0.5, h: 0.5 },
        { x: 0.5, y: 0.5, w: 0.5, h: 0.5 }
      ];
    },
    overlay: [false, false, false]
  },
  'magazine': {
    aspect: 0.75,
    getCells: function() {
      return [
        { x: 0.00, y: 0.00, w: 1.00, h: 1.00 },
        { x: 0.60, y: 0.68, w: 0.37, h: 0.29 }
      ];
    },
    overlay: [false, true]
  },
  'spread': {
    aspect: 1.40,
    getCells: function() {
      return [
        { x: 0.0, y: 0, w: 0.5, h: 1 },
        { x: 0.5, y: 0, w: 0.5, h: 1 }
      ];
    },
    overlay: [false, false]
  }
};

/* ===================================================================
   DOM REFERENCES
=================================================================== */
var canvas     = document.getElementById('mainCanvas');
var ctx        = canvas.getContext('2d');
var canvasWrap = document.getElementById('canvasWrap');
var emptyState = document.getElementById('emptyState');
var exportBtn  = document.getElementById('exportBtn');
var dragHint   = document.getElementById('dragHint');
var fileInput  = document.getElementById('fileInput');
var uploadZone = document.getElementById('uploadZone');

var dragHintTimer = null;

/* ===================================================================
   INIT: set fileInput correctly for default split mode
=================================================================== */
fileInput.multiple = false;

/* Prevent browser from navigating when a file is dropped outside the zone */
document.addEventListener('dragover', function(e) { e.preventDefault(); });
document.addEventListener('drop',     function(e) { e.preventDefault(); });

/* ===================================================================
   FILE UPLOAD
=================================================================== */
uploadZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  uploadZone.classList.add('drag');
});
uploadZone.addEventListener('dragleave', function(e) {
  e.stopPropagation();
  uploadZone.classList.remove('drag');
});
uploadZone.addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  uploadZone.classList.remove('drag');
  if (e.dataTransfer && e.dataTransfer.files.length > 0) {
    handleFiles(e.dataTransfer.files);
  }
});

/* fileInput.change fires after the user selects a file via the dialog */
fileInput.addEventListener('change', function() {
  if (fileInput.files && fileInput.files.length > 0) {
    handleFiles(fileInput.files);
  }
});

function handleFiles(files) {
  var toLoad = [];
  for (var i = 0; i < files.length; i++) {
    if (files[i].type.startsWith('image/')) {
      toLoad.push(files[i]);
    }
  }
  if (toLoad.length === 0) return;

  /* In split mode, only use the first selected file */
  if (S.mode === 'split') { toLoad = [toLoad[0]]; }

  Promise.all(toLoad.map(function(f) { return loadImage(f); }))
    .then(function(imgs) {
      imgs = imgs.filter(function(img) { return img !== null; });
      if (imgs.length === 0) { fileInput.value = ''; return; }

      if (S.mode === 'split') {
        S.images = [imgs[0]];
      } else {
        S.images = S.images.concat(imgs);
      }

      syncImages();

      /* rAF: ensure canvasWrap is visible before drawing */
      requestAnimationFrame(function() {
        render();
        if (!S.hintShown) { S.hintShown = true; showDragHint(); }
      });

      fileInput.value = '';
    })
    .catch(function(err) {
      console.warn('ComicFrame: image load error', err);
      fileInput.value = '';
    });
}

function loadImage(file) {
  return new Promise(function(resolve) {
    var img = new Image();
    img.onload = function() { resolve(img); };
    img.onerror = function() {
      console.warn('ComicFrame: failed to load image', file.name);
      resolve(null); // resolve with null so Promise.all still completes
    };
    img.src = URL.createObjectURL(file);
  });
}

/* ===================================================================
   SYNC STATE AFTER IMAGE / TEMPLATE CHANGE
=================================================================== */
function syncImages() {
  var tmpl  = TEMPLATES[S.template];
  var cells = tmpl.getCells();
  var count = cells.length;

  // Rebuild offsets array, preserving existing values where possible
  var newOffsets = [];
  for (var i = 0; i < count; i++) {
    newOffsets.push(S.cellOffsets[i] ? { x: S.cellOffsets[i].x, y: S.cellOffsets[i].y } : { x: 0, y: 0 });
  }
  S.cellOffsets = newOffsets;

  updateThumbs();
  updateStepHighlights();

  var hasImages = S.images.length > 0;
  exportBtn.disabled    = !hasImages;
  canvasWrap.style.display = hasImages ? 'block' : 'none';
  emptyState.style.display = hasImages ? 'none'  : 'block';
}

/* -------------------------------------------------------------------
   Reset offsets when template changes (user intent: fresh layout)
------------------------------------------------------------------- */
function resetOffsets() {
  var tmpl  = TEMPLATES[S.template];
  var count = tmpl.getCells().length;
  S.cellOffsets = [];
  for (var i = 0; i < count; i++) {
    S.cellOffsets.push({ x: 0, y: 0 });
  }
}

function getCellImage(cellIndex) {
  if (S.images.length === 0) return null;
  if (S.mode === 'split') return S.images[0];
  return S.images[cellIndex % S.images.length] || null;
}

/* ===================================================================
   THUMBNAILS
=================================================================== */
function updateThumbs() {
  var list = document.getElementById('thumbList');
  list.innerHTML = '';
  S.images.forEach(function(img, i) {
    var el = document.createElement('img');
    el.className = 'thumb-item';
    el.src = img.src;
    el.title = '写真 ' + (i + 1);
    list.appendChild(el);
  });
  if (S.images.length > 0) {
    var clr = document.createElement('div');
    clr.className = 'thumb-clear';
    clr.title = '全て削除';
    clr.textContent = '\u00d7';
    clr.addEventListener('click', function() {
      S.images = [];
      S.hintShown = false;
      syncImages();
      requestAnimationFrame(function() { render(); });
    });
    list.appendChild(clr);
  }
}

/* ===================================================================
   SETTINGS
=================================================================== */
function setMode(m) {
  S.mode = m;
  document.getElementById('modeSplit').classList.toggle('active', m === 'split');
  document.getElementById('modeIndiv').classList.toggle('active', m === 'individual');

  // Update file input's multiple attribute
  fileInput.multiple = (m === 'individual');

  // Trim to 1 image when switching back to split mode
  if (m === 'split' && S.images.length > 1) {
    S.images = [S.images[0]];
    syncImages();
  }

  requestAnimationFrame(function() { render(); });
}

function setTemplate(t) {
  S.template = t;
  ['4koma', 'dramatic', 'magazine', 'spread'].forEach(function(id) {
    document.getElementById('t' + id).classList.toggle('active', id === t);
  });
  resetOffsets();   // fresh pan positions for new layout
  syncImages();
  requestAnimationFrame(function() { render(); });
}

function setBorder(k) {
  S.borderKey = k;
  ['thin', 'mid', 'thick'].forEach(function(id) {
    document.getElementById('bw-' + id).classList.toggle('active', id === k);
  });
  requestAnimationFrame(function() { render(); });
}

function setGap(k) {
  S.gapKey = k;
  ['none', 'mid', 'wide'].forEach(function(id) {
    document.getElementById('gap-' + id).classList.toggle('active', id === k);
  });
  requestAnimationFrame(function() { render(); });
}

function setQuality(q) {
  S.quality = q;
  ['standard', 'high'].forEach(function(id) {
    document.getElementById('q-' + id).classList.toggle('active', id === q);
  });
}

function updateStepHighlights() {
  var hasImg = S.images.length > 0;
  ['sn2', 'sn3', 'sn4'].forEach(function(id) {
    document.getElementById(id).classList.toggle('active', hasImg);
  });
  ['st2', 'st3', 'st4'].forEach(function(id) {
    document.getElementById(id).classList.toggle('active', hasImg);
  });
}

/* ===================================================================
   CANVAS SIZING
=================================================================== */
function getCanvasDims() {
  var tmpl = TEMPLATES[S.template];
  var h = BASE_H;
  var w = Math.round(h * tmpl.aspect);
  return { w: w, h: h };
}

function fitCanvas() {
  var area  = document.getElementById('previewArea');
  var dims  = getCanvasDims();
  var avW   = area.clientWidth  - 48;
  var avH   = area.clientHeight - 80;
  if (avW <= 0 || avH <= 0) return;
  var scale = Math.min(avW / dims.w, avH / dims.h, 1);
  canvas.style.width  = Math.round(dims.w * scale) + 'px';
  canvas.style.height = Math.round(dims.h * scale) + 'px';
}

window.addEventListener('resize', function() {
  fitCanvas();
});

/* ===================================================================
   PIXEL CELL CALCULATOR
   Returns array of pixel-space rect descriptors for the current state.
=================================================================== */
function computePixelCells(cW, cH, scale) {
  var tmpl      = TEMPLATES[S.template];
  var normCells = tmpl.getCells();
  var gap       = GAP_MAP[S.gapKey] * scale;
  var bw        = BORDER_MAP[S.borderKey] * scale;

  return normCells.map(function(nc, i) {
    var isOverlay = tmpl.overlay[i];
    var rx = nc.x * cW;
    var ry = nc.y * cH;
    var rw = nc.w * cW;
    var rh = nc.h * cH;

    if (!isOverlay && gap > 0) {
      var atLeft   = nc.x < 0.01;
      var atTop    = nc.y < 0.01;
      var atRight  = nc.x + nc.w > 0.99;
      var atBottom = nc.y + nc.h > 0.99;

      var gl = atLeft   ? 0 : gap / 2;
      var gt = atTop    ? 0 : gap / 2;
      var gr = atRight  ? 0 : gap / 2;
      var gb = atBottom ? 0 : gap / 2;

      rx += gl;
      ry += gt;
      rw -= (gl + gr);
      rh -= (gt + gb);
    }

    // Image clip rect (inset by border)
    var ix = rx + bw;
    var iy = ry + bw;
    var iw = rw - 2 * bw;
    var ih = rh - 2 * bw;

    return { rx: rx, ry: ry, rw: rw, rh: rh,
             ix: ix, iy: iy, iw: iw, ih: ih,
             isOverlay: isOverlay };
  });
}

/* ===================================================================
   IMAGE COVER DRAW HELPER
=================================================================== */
function drawImageCover(targetCtx, img, cx, cy, cw, ch, offX, offY) {
  if (!img || cw <= 0 || ch <= 0) return;

  var imgAspect  = img.naturalWidth / img.naturalHeight;
  var cellAspect = cw / ch;
  var dw, dh;

  if (imgAspect > cellAspect) {
    dh = ch;
    dw = ch * imgAspect;
  } else {
    dw = cw;
    dh = cw / imgAspect;
  }

  var maxOX = (dw - cw) / 2;
  var maxOY = (dh - ch) / 2;
  var ox = Math.max(-maxOX, Math.min(maxOX, offX));
  var oy = Math.max(-maxOY, Math.min(maxOY, offY));

  targetCtx.drawImage(img, cx + cw / 2 - dw / 2 + ox, cy + ch / 2 - dh / 2 + oy, dw, dh);
}

/* ===================================================================
   RENDER CORE  (works on any canvas/context at any scale)
=================================================================== */
function renderToContext(targetCanvas, targetCtx, scale) {
  var dims = getCanvasDims();
  var cW   = dims.w * scale;
  var cH   = dims.h * scale;
  var bw   = BORDER_MAP[S.borderKey] * scale;

  targetCanvas.width  = cW;
  targetCanvas.height = cH;

  // Background
  targetCtx.fillStyle = '#000000';
  targetCtx.fillRect(0, 0, cW, cH);

  if (S.images.length === 0) return;

  var cells = computePixelCells(cW, cH, scale);

  cells.forEach(function(cell, i) {
    var img = getCellImage(i);
    if (!img || cell.iw <= 0 || cell.ih <= 0) return;

    var off = S.cellOffsets[i] || { x: 0, y: 0 };

    // Clip and draw image
    targetCtx.save();
    targetCtx.beginPath();
    targetCtx.rect(cell.ix, cell.iy, cell.iw, cell.ih);
    targetCtx.clip();
    drawImageCover(targetCtx, img, cell.ix, cell.iy, cell.iw, cell.ih,
                   off.x * scale, off.y * scale);
    targetCtx.restore();

    // Outer border
    if (bw > 0) {
      targetCtx.strokeStyle = '#000000';
      targetCtx.lineWidth   = bw;
      targetCtx.strokeRect(cell.rx + bw / 2, cell.ry + bw / 2,
                            cell.rw - bw,     cell.rh - bw);
    }

    // Extra thick border for overlay (PiP) cell
    if (cell.isOverlay && bw > 0) {
      targetCtx.strokeStyle = '#000000';
      targetCtx.lineWidth   = bw * 1.5;
      targetCtx.strokeRect(cell.rx + bw / 2, cell.ry + bw / 2,
                            cell.rw - bw,     cell.rh - bw);
    }
  });
}

/* --- Main preview render (scale=1, fits CSS after) --- */
function render() {
  renderToContext(canvas, ctx, 1);
  fitCanvas();
}

/* ===================================================================
   DRAG / PAN
=================================================================== */
function getCellAtPoint(px, py) {
  var dims   = getCanvasDims();
  var cRect  = canvas.getBoundingClientRect();
  if (cRect.width === 0 || cRect.height === 0) return -1;

  var scaleX = dims.w / cRect.width;
  var scaleY = dims.h / cRect.height;
  var cx = (px - cRect.left) * scaleX;
  var cy = (py - cRect.top)  * scaleY;

  var cells = computePixelCells(dims.w, dims.h, 1);
  // Reverse so overlay cells (rendered last) have hit-test priority
  for (var i = cells.length - 1; i >= 0; i--) {
    var c = cells[i];
    if (cx >= c.rx && cx <= c.rx + c.rw && cy >= c.ry && cy <= c.ry + c.rh) {
      return i;
    }
  }
  return -1;
}

canvas.addEventListener('mousedown', function(e) {
  var ci = getCellAtPoint(e.clientX, e.clientY);
  if (ci < 0 || !getCellImage(ci)) return;
  S.dragging  = ci;
  S.dragStart = { x: e.clientX, y: e.clientY };
  S.dragOffset = { x: S.cellOffsets[ci].x, y: S.cellOffsets[ci].y };
  canvas.style.cursor = 'grabbing';
  e.preventDefault();
});

canvas.addEventListener('mousemove', function(e) {
  if (S.dragging < 0) {
    var ci = getCellAtPoint(e.clientX, e.clientY);
    canvas.style.cursor = (ci >= 0 && getCellImage(ci)) ? 'grab' : 'crosshair';
    return;
  }
  var dims   = getCanvasDims();
  var cRect  = canvas.getBoundingClientRect();
  var scaleX = dims.w / cRect.width;

  var dx = (e.clientX - S.dragStart.x) / scaleX;
  var dy = (e.clientY - S.dragStart.y) / scaleX;

  S.cellOffsets[S.dragging] = {
    x: S.dragOffset.x + dx,
    y: S.dragOffset.y + dy
  };
  render();
});

canvas.addEventListener('mouseup', function() {
  S.dragging = -1;
  canvas.style.cursor = 'crosshair';
});

canvas.addEventListener('mouseleave', function() {
  if (S.dragging >= 0) {
    S.dragging = -1;
    canvas.style.cursor = 'crosshair';
  }
});

/* --- Touch support --- */
canvas.addEventListener('touchstart', function(e) {
  e.preventDefault();
  var t  = e.touches[0];
  var ci = getCellAtPoint(t.clientX, t.clientY);
  if (ci < 0 || !getCellImage(ci)) return;
  S.dragging   = ci;
  S.dragStart  = { x: t.clientX, y: t.clientY };
  S.dragOffset = { x: S.cellOffsets[ci].x, y: S.cellOffsets[ci].y };
}, { passive: false });

canvas.addEventListener('touchmove', function(e) {
  e.preventDefault();
  if (S.dragging < 0) return;
  var t     = e.touches[0];
  var dims  = getCanvasDims();
  var cRect = canvas.getBoundingClientRect();
  var scaleX = dims.w / cRect.width;
  S.cellOffsets[S.dragging] = {
    x: S.dragOffset.x + (t.clientX - S.dragStart.x) / scaleX,
    y: S.dragOffset.y + (t.clientY - S.dragStart.y) / scaleX
  };
  render();
}, { passive: false });

canvas.addEventListener('touchend', function() {
  S.dragging = -1;
});

function showDragHint() {
  dragHint.classList.add('show');
  clearTimeout(dragHintTimer);
  dragHintTimer = setTimeout(function() {
    dragHint.classList.remove('show');
  }, 3000);
}

/* ===================================================================
   EXPORT
=================================================================== */
function exportImage() {
  var scale      = QUALITY_MAP[S.quality];
  var offCanvas  = document.createElement('canvas');
  var offCtx     = offCanvas.getContext('2d');

  renderToContext(offCanvas, offCtx, scale);

  var link     = document.createElement('a');
  link.download = 'comicframe_' + Date.now() + '.png';
  link.href    = offCanvas.toDataURL('image/png');
  link.click();
}

/* ===================================================================
   INITIAL RENDER
=================================================================== */
render();
updateStepHighlights();
</script>
</body>
</html>
