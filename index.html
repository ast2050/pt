<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ComicFrame</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0a;--panel:#111;--card:#1c1c1c;--card2:#262626;
  --border:#2e2e2e;--accent:#f5c518;--accent2:#e6b800;
  --text:#f0f0f0;--muted:#777;--danger:#ff4444;
  --pen:#22d3ee;--r:8px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:14px;
  -webkit-tap-highlight-color:transparent;touch-action:none}

/* ---- layout ---- */
.app{display:flex;flex-direction:column;height:100dvh;overflow:hidden}

/* ---- top bar ---- */
.topbar{
  flex-shrink:0;height:46px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;background:var(--panel);border-bottom:1px solid var(--border);
}
.logo{font-family:'Bebas Neue',sans-serif;font-size:21px;letter-spacing:2px;color:var(--accent)}
.logo small{font-family:'DM Sans',sans-serif;font-size:9px;color:var(--muted);
  letter-spacing:0;margin-left:5px}
.tools{display:flex;gap:5px}
.tbtn{
  padding:5px 11px;border:1px solid var(--border);border-radius:20px;
  background:var(--card);color:var(--muted);font-size:11px;
  font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap
}
.tbtn:active{opacity:.7}
.tbtn.on{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}
.tbtn.pen-on{background:var(--pen);color:#000;border-color:var(--pen);font-weight:600}
.tbtn:disabled{opacity:.3;pointer-events:none}

/* ---- preview ---- */
.preview-section{
  flex:1;min-height:0;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);position:relative;overflow:hidden;
}
#cWrap{position:relative;display:inline-block;
  box-shadow:0 0 50px rgba(0,0,0,.95),0 0 0 1px var(--border)}
#mCanvas{display:block;touch-action:none}
#oCanvas{position:absolute;top:0;left:0;pointer-events:none}

/* toasts / hints */
.pen-badge{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  font-size:11px;background:var(--pen);color:#000;font-weight:600;
  padding:4px 14px;border-radius:20px;pointer-events:none;
  opacity:0;transition:opacity .25s;white-space:nowrap;
}
.pen-badge.show{opacity:1}
.toast{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  font-size:11px;color:var(--muted);background:rgba(0,0,0,.85);
  padding:5px 14px;border-radius:20px;pointer-events:none;
  opacity:0;transition:opacity .3s;white-space:nowrap;
}
.toast.show{opacity:1}

/* ---- ctrl panel ---- */
.ctrl{
  flex-shrink:0;background:var(--panel);
  border-top:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
}
.tabs{display:flex;flex-shrink:0;border-bottom:1px solid var(--border)}
.tab{
  flex:1;padding:9px 2px;border:none;background:transparent;
  color:var(--muted);font-size:11px;font-family:'DM Sans',sans-serif;cursor:pointer;
  border-bottom:2px solid transparent;position:relative;bottom:-1px;transition:all .2s
}
.tab.on{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tc{display:none;overflow-y:auto;padding:10px 12px;flex:1}
.tc.on{display:block}
.tc::-webkit-scrollbar{width:3px}
.tc::-webkit-scrollbar-thumb{background:var(--border)}

/* template strip */
.tmpl-strip{display:flex;gap:7px;overflow-x:auto;padding:2px 0 6px;
  -webkit-overflow-scrolling:touch}
.tmpl-strip::-webkit-scrollbar{height:2px}
.tmpl-strip::-webkit-scrollbar-thumb{background:var(--border)}
.tcard{flex-shrink:0;cursor:pointer;text-align:center}
.tthumb{border-radius:4px;border:2px solid var(--border);overflow:hidden;
  background:var(--card2);transition:border-color .2s}
.tcard.on .tthumb{border-color:var(--accent)}
.tthumb svg{display:block}
.tname{font-size:9px;color:var(--muted);margin-top:3px;line-height:1.3}
.tcard.on .tname{color:var(--accent)}

/* mode row */
.mrow{display:flex;background:var(--card);border-radius:var(--r);padding:3px;gap:3px;margin-bottom:8px}
.mbtn{flex:1;padding:7px 4px;border:none;border-radius:6px;background:transparent;
  color:var(--muted);font-size:11px;font-family:'DM Sans',sans-serif;cursor:pointer;
  transition:all .2s;text-align:center;line-height:1.4}
.mbtn.on{background:var(--accent);color:#000;font-weight:600}

/* upload label */
.ulbl{
  display:flex;align-items:center;justify-content:center;gap:8px;
  border:2px dashed var(--border);border-radius:var(--r);padding:10px;
  cursor:pointer;color:var(--muted);font-size:12px;transition:all .2s;
  user-select:none;-webkit-user-select:none
}
.ulbl:hover,.ulbl.drag{border-color:var(--accent);color:var(--accent)}
#fInput,#fInputCell{display:none}

/* cell grid */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(54px,1fr));gap:5px;margin-top:6px}
.cslot{
  border:1.5px dashed var(--border);border-radius:6px;padding:6px 3px;
  text-align:center;cursor:pointer;font-size:9px;color:var(--muted);
  transition:all .2s;user-select:none;-webkit-user-select:none
}
.cslot.has{border-color:#444;color:var(--text)}
.cslot.sel{border-color:var(--accent);color:var(--accent)}
.cslot img{width:100%;height:32px;object-fit:cover;border-radius:3px;display:block;margin-bottom:2px}

/* zoom row */
.zrow{display:flex;align-items:center;gap:8px;margin-top:6px}
.zslider{flex:1;-webkit-appearance:none;appearance:none;height:4px;
  border-radius:2px;background:var(--card2);outline:none;cursor:pointer}
.zslider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;
  border-radius:50%;background:var(--accent);cursor:pointer}
.zslider::-moz-range-thumb{width:18px;height:18px;border-radius:50%;
  background:var(--accent);cursor:pointer;border:none}
.zval{font-size:11px;color:var(--muted);min-width:34px;text-align:right}

/* tri-select */
.tri{display:flex;background:var(--card);border-radius:var(--r);padding:3px;gap:3px}
.trbtn{flex:1;padding:6px 2px;border:none;border-radius:6px;background:transparent;
  color:var(--muted);font-size:11px;font-family:'DM Sans',sans-serif;cursor:pointer;
  transition:all .2s;text-align:center;line-height:1.4}
.trbtn.on{background:var(--card2);color:var(--text);box-shadow:inset 0 0 0 1px var(--border)}

/* field label */
.fl{font-size:10px;font-weight:500;color:var(--muted);letter-spacing:.3px;
  text-transform:uppercase;margin:8px 0 5px}
.fl:first-child{margin-top:0}

/* save button */
.savebtn{
  width:100%;padding:12px;border:none;border-radius:var(--r);
  background:var(--accent);color:#000;font-family:'Bebas Neue',sans-serif;
  font-size:16px;letter-spacing:2px;cursor:pointer;transition:all .2s;margin-top:8px
}
.savebtn:hover:not(:disabled){background:var(--accent2)}
.savebtn:disabled{background:var(--card2);color:var(--muted);cursor:not-allowed}
.savenote{font-size:10px;color:var(--muted);text-align:center;margin-top:6px;line-height:1.5}

.smallbtn{
  padding:5px 10px;border:1px solid var(--border);border-radius:5px;
  background:transparent;color:var(--muted);font-size:10px;cursor:pointer;
  font-family:'DM Sans',sans-serif;transition:all .2s
}
.smallbtn:hover{color:var(--text);border-color:#555}

.empty-state{
  position:absolute;text-align:center;color:var(--muted);pointer-events:none
}
.empty-state .eico{font-size:44px;opacity:.1;margin-bottom:10px}
.empty-state p{font-size:12px;line-height:1.7}
</style>
</head>
<body>
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="logo">CF <small>ComicFrame</small></div>
    <div class="tools">
      <button class="tbtn on"  id="btnSelect" onclick="setTool('select')" title="選択/移動モード">&#9654; 選択</button>
      <button class="tbtn"     id="btnPen"    onclick="setTool('pen')"    title="コマ分割ペン">&#9998; ペン</button>
      <button class="tbtn"     id="btnUndo"   onclick="undo()"            title="一手戻す" disabled>&#8630; 戻す</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section" id="previewSection">
    <div id="emptyState" class="empty-state">
      <div class="eico">&#127902;</div>
      <p>写真タブから写真を追加<br>ペンモードでコマを自由分割</p>
    </div>
    <div id="cWrap">
      <canvas id="mCanvas"></canvas>
      <canvas id="oCanvas"></canvas>
    </div>
    <div class="pen-badge" id="penBadge">&#9998; ペンモード: コマ内でドラッグして分割</div>
    <div class="toast"     id="toast">ドラッグで移動 / ピンチで拡大縮小</div>
  </div>

  <!-- CONTROLS -->
  <div class="ctrl" id="ctrl">

    <div class="tabs">
      <button class="tab on"  data-tc="tc1" onclick="switchTab('tc1')">テンプレ</button>
      <button class="tab"     data-tc="tc2" onclick="switchTab('tc2')">写真</button>
      <button class="tab"     data-tc="tc3" onclick="switchTab('tc3')">フレーム</button>
      <button class="tab"     data-tc="tc4" onclick="switchTab('tc4')">保存</button>
    </div>

    <!-- ── Tab 1: Template ── -->
    <div class="tc on" id="tc1">
      <div class="fl">コマ割りテンプレート</div>
      <div class="tmpl-strip" id="tmplStrip"></div>
      <p style="font-size:10px;color:var(--muted);margin-top:6px">
        テンプレを選択後、ペンモードでコマを自由に分割できます
      </p>
    </div>

    <!-- ── Tab 2: Photo ── -->
    <div class="tc" id="tc2">
      <div class="fl">配置モード</div>
      <div class="mrow">
        <button class="mbtn on" id="btnMSplit" onclick="setMode('split')">
          ぶち抜き<br><span style="font-size:9px;opacity:.7">1枚を全コマ貫通</span>
        </button>
        <button class="mbtn" id="btnMIndiv" onclick="setMode('indiv')">
          個別配置<br><span style="font-size:9px;opacity:.7">コマごとに別の写真</span>
        </button>
      </div>

      <!-- split mode -->
      <div id="pSplit">
        <label class="ulbl" id="uploadZone" for="fInput">
          &#128194; 写真を選択またはドロップ
        </label>
        <div id="zPanelSplit" style="display:none;margin-top:8px">
          <div class="fl">全体ズーム</div>
          <div class="zrow">
            <span style="font-size:12px">&#128269;</span>
            <input type="range" class="zslider" id="zGlobal" min="100" max="500" value="100"
                   oninput="onZoomGlobal(this.value)">
            <span class="zval" id="zGlobalVal">1.0x</span>
          </div>
          <button class="smallbtn" style="margin-top:5px" onclick="resetGlobal()">リセット</button>
        </div>
      </div>

      <!-- indiv mode -->
      <div id="pIndiv" style="display:none">
        <div class="fl">コマをタップして写真を割り当て</div>
        <div class="cgrid" id="cellGrid"></div>
        <div id="zPanelCell" style="display:none;margin-top:8px">
          <div class="fl" id="zCellLbl">コマ1 ズーム</div>
          <div class="zrow">
            <span style="font-size:12px">&#128269;</span>
            <input type="range" class="zslider" id="zCell" min="100" max="500" value="100"
                   oninput="onZoomCell(this.value)">
            <span class="zval" id="zCellVal">1.0x</span>
          </div>
          <div style="display:flex;gap:6px;margin-top:5px">
            <button class="smallbtn" onclick="resetActiveCell()">リセット</button>
            <button class="smallbtn" onclick="clearActiveCell()">削除</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Tab 3: Frame ── -->
    <div class="tc" id="tc3">
      <div class="fl">枠線の太さ</div>
      <div class="tri">
        <button class="trbtn on" id="bw-thin"  onclick="setBorder('thin')">細い 2px</button>
        <button class="trbtn"    id="bw-mid"   onclick="setBorder('mid')">中 5px</button>
        <button class="trbtn"    id="bw-thick" onclick="setBorder('thick')">太い 10px</button>
      </div>
      <div class="fl">コマ間の余白（ドブ）</div>
      <div class="tri">
        <button class="trbtn on" id="gap-none" onclick="setGap('none')">なし</button>
        <button class="trbtn"    id="gap-mid"  onclick="setGap('mid')">中 8px</button>
        <button class="trbtn"    id="gap-wide" onclick="setGap('wide')">広め 18px</button>
      </div>
    </div>

    <!-- ── Tab 4: Save ── -->
    <div class="tc" id="tc4">
      <div class="fl">書き出し画質</div>
      <div class="tri">
        <button class="trbtn on" id="q-std" onclick="setQuality('std')">
          SNS用<br><span style="font-size:9px;opacity:.7">1x</span>
        </button>
        <button class="trbtn"    id="q-hi"  onclick="setQuality('hi')">
          高画質<br><span style="font-size:9px;opacity:.7">3x</span>
        </button>
      </div>
      <button class="savebtn" id="btnSave" onclick="saveImage()" disabled>
        &#11015;&#xFE0E; 保存する
      </button>
      <div class="savenote" id="saveNote">
        スマホ: 写真アプリへ直接保存<br>PC: PNGダウンロード
      </div>
    </div>

  </div><!-- /ctrl -->
</div><!-- /app -->

<input type="file" id="fInput"     accept="image/*">
<input type="file" id="fInputCell" accept="image/*">

<script>
/* ==========================================================
   TEMPLATES
========================================================== */
var TEMPLATES = [
  {
    id:'blank', name:'白紙\n(1コマ)', aspect:0.75,
    cells:[{x:0,y:0,w:1,h:1}],
    svgW:60, svgH:80,
    svgCells:'<rect x="2" y="2" width="56" height="76" fill="#444" rx="1"/>'
  },
  {
    id:'manga6', name:'6コマ\n漫画型', aspect:0.68,
    cells:[
      {x:0.59,y:0.00,w:0.41,h:0.39},
      {x:0.37,y:0.00,w:0.22,h:0.39},
      {x:0.00,y:0.00,w:0.37,h:0.39},
      {x:0.00,y:0.39,w:1.00,h:0.21},
      {x:0.50,y:0.60,w:0.50,h:0.40},
      {x:0.00,y:0.60,w:0.50,h:0.40}
    ],
    svgW:60, svgH:88,
    svgCells:'<rect x="2" y="2" width="21" height="31" fill="#444" rx="1"/>'
      +'<rect x="25" y="2" width="12" height="31" fill="#444" rx="1"/>'
      +'<rect x="39" y="2" width="19" height="31" fill="#444" rx="1"/>'
      +'<rect x="2" y="35" width="56" height="17" fill="#444" rx="1"/>'
      +'<rect x="2" y="54" width="26" height="32" fill="#444" rx="1"/>'
      +'<rect x="30" y="54" width="28" height="32" fill="#444" rx="1"/>'
  },
  {
    id:'4koma', name:'4コマ型', aspect:0.60,
    cells:[
      {x:0,y:0.00,w:1,h:0.25},{x:0,y:0.25,w:1,h:0.25},
      {x:0,y:0.50,w:1,h:0.25},{x:0,y:0.75,w:1,h:0.25}
    ],
    svgW:60, svgH:100,
    svgCells:'<rect x="2" y="2"  width="56" height="21" fill="#444" rx="1"/>'
      +'<rect x="2" y="26" width="56" height="21" fill="#444" rx="1"/>'
      +'<rect x="2" y="50" width="56" height="21" fill="#444" rx="1"/>'
      +'<rect x="2" y="74" width="56" height="24" fill="#444" rx="1"/>'
  },
  {
    id:'dramatic', name:'ドラマ型', aspect:0.80,
    cells:[
      {x:0,y:0,w:1,h:0.5},
      {x:0,y:0.5,w:0.5,h:0.5},
      {x:0.5,y:0.5,w:0.5,h:0.5}
    ],
    svgW:60, svgH:75,
    svgCells:'<rect x="2" y="2"  width="56" height="33" fill="#444" rx="1"/>'
      +'<rect x="2" y="38" width="26" height="35" fill="#444" rx="1"/>'
      +'<rect x="32" y="38" width="26" height="35" fill="#444" rx="1"/>'
  },
  {
    id:'spread', name:'見開き型', aspect:1.40,
    cells:[
      {x:0,y:0,w:0.5,h:1},
      {x:0.5,y:0,w:0.5,h:1}
    ],
    svgW:80, svgH:57,
    svgCells:'<rect x="2" y="2" width="35" height="53" fill="#444" rx="1"/>'
      +'<rect x="43" y="2" width="35" height="53" fill="#444" rx="1"/>'
  }
];

/* ==========================================================
   CONSTANTS
========================================================== */
var BORDER_MAP = {thin:2, mid:5, thick:10};
var GAP_MAP    = {none:0, mid:8, wide:18};
var QUAL_MAP   = {std:1, hi:3};
var BASE_H     = 900;
var MIN_RATIO  = 0.08;   // min panel fraction before split clamp
var PEN_THRESH = 12;     // min canvas-px drag to count as a split

/* ==========================================================
   STATE
========================================================== */
var S = {
  tmplIdx:    1,        // index into TEMPLATES
  mode:       'split',  // 'split' | 'indiv'
  tool:       'select', // 'select' | 'pen'

  panels:     [],       // [{id, x, y, w, h}]  normalized 0-1
  history:    [],       // snapshots for undo (max 12)
  pImages:    {},       // {panelId: HTMLImageElement}
  pState:     {},       // {panelId: {ox, oy, scale}}
  nextId:     0,

  splitImg:   null,
  splitSt:    {ox:0, oy:0, scale:1},

  activeId:   -1,       // currently selected panel id (-1 = none)
  pendCell:   -1,       // panel id waiting for file upload

  borderKey:  'thin',
  gapKey:     'none',
  quality:    'std',

  /* interaction */
  iMode:      null,     // 'pan' | 'pinch' | 'draw'
  iPanelId:   -1,       // panel being interacted with
  iStart:     null,     // {cx,cy} canvas coords at gesture start
  iStartOff:  null,     // {ox,oy} copy of offset at gesture start
  iStartSc:   1,
  iStartDist: 0,
  drawEnd:    null,     // {cx,cy} current pen drag endpoint

  hintShown:  false
};

/* ==========================================================
   DOM REFS
========================================================== */
var mCanvas   = document.getElementById('mCanvas');
var oCanvas   = document.getElementById('oCanvas');
var mCtx      = mCanvas.getContext('2d');
var oCtx      = oCanvas.getContext('2d');
var cWrap     = document.getElementById('cWrap');
var prevSec   = document.getElementById('previewSection');
var emptyEl   = document.getElementById('emptyState');
var penBadge  = document.getElementById('penBadge');
var toastEl   = document.getElementById('toast');
var btnUndo   = document.getElementById('btnUndo');
var btnSave   = document.getElementById('btnSave');
var fInput    = document.getElementById('fInput');
var fInputCell= document.getElementById('fInputCell');
var ctrl      = document.getElementById('ctrl');

var toastTimer = null;
var penBadgeTimer = null;

/* ==========================================================
   INIT
========================================================== */
document.addEventListener('dragover', function(e){e.preventDefault();});
document.addEventListener('drop',     function(e){e.preventDefault();});

buildTemplateStrip();
loadTemplate(1, false);
syncCtrlHeight();

window.addEventListener('resize', function(){
  syncCtrlHeight();
  fitCanvas();
});

/* ==========================================================
   TEMPLATE STRIP
========================================================== */
function buildTemplateStrip(){
  var strip = document.getElementById('tmplStrip');
  strip.innerHTML = '';
  TEMPLATES.forEach(function(t, i){
    var card = document.createElement('div');
    card.className = 'tcard' + (i === S.tmplIdx ? ' on' : '');
    card.id = 'tc_' + i;
    var w = t.svgW, h = t.svgH;
    var displayH = 68, displayW = Math.round(displayH * (w/h));
    card.innerHTML =
      '<div class="tthumb" style="width:' + displayW + 'px;height:' + displayH + 'px">'
      + '<svg width="' + displayW + '" height="' + displayH + '" viewBox="0 0 ' + w + ' ' + h + '" fill="none">'
      + '<rect width="' + w + '" height="' + h + '" fill="#1a1a1a"/>'
      + t.svgCells
      + '</svg></div>'
      + '<div class="tname">' + t.name.replace('\n','<br>') + '</div>';
    card.onclick = (function(idx){ return function(){ loadTemplate(idx, true); }; })(i);
    strip.appendChild(card);
  });
}

/* ==========================================================
   PANEL MANAGEMENT
========================================================== */
function loadTemplate(idx, resetImages){
  S.tmplIdx = idx;
  var tmpl = TEMPLATES[idx];
  S.nextId = 0;
  S.panels = tmpl.cells.map(function(c){
    return {id:S.nextId++, x:c.x, y:c.y, w:c.w, h:c.h};
  });
  S.history = [];
  if(resetImages){
    S.pImages = {};
    S.pState  = {};
    S.splitImg = null;
    S.splitSt  = {ox:0, oy:0, scale:1};
  } else {
    // keep images from old panels if ids happen to match (they won't after reset)
    S.pImages = {};
    S.pState  = {};
  }
  S.activeId = -1;
  S.iMode    = null;
  document.querySelectorAll('.tcard').forEach(function(c,i){
    c.classList.toggle('on', i===idx);
  });
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function getPanelById(id){
  for(var i=0;i<S.panels.length;i++) if(S.panels[i].id===id) return S.panels[i];
  return null;
}

function getPanelAt(cx, cy){
  var dims = getCanvasDims();
  var bw   = BORDER_MAP[S.borderKey];
  var gap  = GAP_MAP[S.gapKey];
  // search reverse so later panels have priority
  for(var i=S.panels.length-1;i>=0;i--){
    var r = panelPxRect(S.panels[i], dims.w, dims.h, bw, gap);
    if(cx>=r.rx && cx<=r.rx+r.rw && cy>=r.ry && cy<=r.ry+r.rh) return S.panels[i];
  }
  return null;
}

function panelPxRect(panel, cW, cH, bw, gap){
  var eps=0.004;
  var rx=panel.x*cW, ry=panel.y*cH, rw=panel.w*cW, rh=panel.h*cH;
  if(gap>0){
    var atL=panel.x<eps, atT=panel.y<eps;
    var atR=panel.x+panel.w>1-eps, atB=panel.y+panel.h>1-eps;
    var gl=atL?0:gap/2, gt=atT?0:gap/2, gr=atR?0:gap/2, gb=atB?0:gap/2;
    rx+=gl; ry+=gt; rw-=(gl+gr); rh-=(gt+gb);
  }
  return {rx:rx, ry:ry, rw:rw, rh:rh,
          ix:rx+bw, iy:ry+bw, iw:rw-2*bw, ih:rh-2*bw};
}

/* snapshot & undo */
function pushHistory(){
  S.history.push({
    panels:   S.panels.map(function(p){return {id:p.id,x:p.x,y:p.y,w:p.w,h:p.h};}),
    pImages:  Object.assign({}, S.pImages),
    pState:   JSON.parse(JSON.stringify(S.pState)),
    nextId:   S.nextId
  });
  if(S.history.length>12) S.history.shift();
  syncUndoBtn();
}

function undo(){
  if(!S.history.length) return;
  var prev = S.history.pop();
  S.panels  = prev.panels;
  S.pImages = prev.pImages;
  S.pState  = prev.pState;
  S.nextId  = prev.nextId;
  S.activeId = -1;
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function syncUndoBtn(){
  btnUndo.disabled = S.history.length===0;
}

/* split a panel */
function splitPanel(panelId, x1,y1,x2,y2){
  var panel = getPanelById(panelId);
  if(!panel) return;

  var dims = getCanvasDims();
  var dx   = x2-x1, dy = y2-y1;
  var isH  = Math.abs(dx) > Math.abs(dy); // horizontal split if dx dominant

  var px=panel.x*dims.w, py=panel.y*dims.h, pw=panel.w*dims.w, ph=panel.h*dims.h;
  var mx=(x1+x2)/2, my=(y1+y2)/2;

  var idA=S.nextId++, idB=S.nextId++;
  var pA, pB;

  if(isH){
    var sy = Math.max(py+ph*MIN_RATIO, Math.min(py+ph*(1-MIN_RATIO), my));
    var ratio = (sy-py)/ph;
    pA = {id:idA, x:panel.x, y:panel.y,         w:panel.w, h:panel.h*ratio};
    pB = {id:idB, x:panel.x, y:panel.y+panel.h*ratio, w:panel.w, h:panel.h*(1-ratio)};
  } else {
    var sx = Math.max(px+pw*MIN_RATIO, Math.min(px+pw*(1-MIN_RATIO), mx));
    var ratio = (sx-px)/pw;
    pA = {id:idA, x:panel.x,         y:panel.y, w:panel.w*ratio,     h:panel.h};
    pB = {id:idB, x:panel.x+panel.w*ratio, y:panel.y, w:panel.w*(1-ratio), h:panel.h};
  }

  /* inherit parent image/state */
  var parentImg = S.pImages[panelId];
  var parentSt  = S.pState[panelId] || {ox:0,oy:0,scale:1};
  if(parentImg){
    S.pImages[idA] = parentImg;
    S.pImages[idB] = parentImg;
  }
  S.pState[idA] = {ox:parentSt.ox, oy:parentSt.oy, scale:parentSt.scale};
  S.pState[idB] = {ox:parentSt.ox, oy:parentSt.oy, scale:parentSt.scale};

  /* replace in array */
  var idx = S.panels.findIndex(function(p){return p.id===panelId;});
  if(idx<0) return;
  S.panels.splice(idx,1,pA,pB);

  /* cleanup parent */
  delete S.pImages[panelId];
  delete S.pState[panelId];

  S.activeId = idA;
}

/* ==========================================================
   CANVAS SIZING
========================================================== */
function getCanvasDims(){
  var tmpl = TEMPLATES[S.tmplIdx];
  return {w:Math.round(BASE_H*tmpl.aspect), h:BASE_H};
}

function fitCanvas(){
  var dims = getCanvasDims();
  var avW  = prevSec.clientWidth  - 16;
  var avH  = prevSec.clientHeight - 16;
  if(avW<=0||avH<=0) return;
  var sc = Math.min(avW/dims.w, avH/dims.h, 1);
  var dw = Math.round(dims.w*sc), dh = Math.round(dims.h*sc);
  mCanvas.style.width  = dw+'px';
  mCanvas.style.height = dh+'px';
  oCanvas.style.width  = dw+'px';
  oCanvas.style.height = dh+'px';
  oCanvas.width  = dims.w;
  oCanvas.height = dims.h;
}

function syncCtrlHeight(){
  var ctrlH = Math.min(Math.max(Math.round(window.innerHeight*0.36), 220), 265);
  ctrl.style.height = ctrlH+'px';
}

/* ==========================================================
   COORDINATE HELPERS
========================================================== */
function toCanvas(clientX, clientY){
  var r = mCanvas.getBoundingClientRect();
  if(!r.width) return {cx:0,cy:0};
  return {
    cx:(clientX-r.left)*(mCanvas.width /r.width),
    cy:(clientY-r.top) *(mCanvas.height/r.height)
  };
}

function touchMid(touches){
  return {
    cx:(touches[0].clientX+touches[1].clientX)/2,
    cy:(touches[0].clientY+touches[1].clientY)/2
  };
}

function touchDist(touches){
  var dx=touches[0].clientX-touches[1].clientX;
  var dy=touches[0].clientY-touches[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}

/* ==========================================================
   RENDERING
========================================================== */
function drawCover(tc, img, ix, iy, iw, ih, ox, oy, sc){
  if(!img||iw<=0||ih<=0) return;
  var ia=img.naturalWidth/img.naturalHeight, ca=iw/ih;
  var bw,bh;
  if(ia>ca){bh=ih;bw=ih*ia;}else{bw=iw;bh=iw/ia;}
  var dw=bw*sc, dh=bh*sc;
  var mox=Math.max(0,(dw-iw)/2), moy=Math.max(0,(dh-ih)/2);
  var ox2=Math.max(-mox,Math.min(mox,ox));
  var oy2=Math.max(-moy,Math.min(moy,oy));
  tc.drawImage(img, ix+iw/2-dw/2+ox2, iy+ih/2-dh/2+oy2, dw, dh);
}

function renderCore(tc, tCanvas, scale, drawGuides){
  var dims = getCanvasDims();
  var cW=dims.w*scale, cH=dims.h*scale;
  var bw=BORDER_MAP[S.borderKey]*scale, gap=GAP_MAP[S.gapKey]*scale;

  tCanvas.width=cW; tCanvas.height=cH;
  tc.fillStyle='#000'; tc.fillRect(0,0,cW,cH);

  if(S.mode==='split'){
    /* single image behind all panels */
    if(S.splitImg){
      var img=S.splitImg;
      var st=S.splitSt;
      var ia=img.naturalWidth/img.naturalHeight, ca=cW/cH;
      var bw2,bh2;
      if(ia>ca){bh2=cH;bw2=cH*ia;}else{bw2=cW;bh2=cW/ia;}
      var dw=bw2*st.scale, dh=bh2*st.scale;
      var mox=Math.max(0,(dw-cW)/2), moy=Math.max(0,(dh-cH)/2);
      var ox=Math.max(-mox,Math.min(mox,st.ox*scale));
      var oy=Math.max(-moy,Math.min(moy,st.oy*scale));
      var imgX=cW/2-dw/2+ox, imgY=cH/2-dh/2+oy;

      S.panels.forEach(function(p){
        var r=panelPxRect(p,cW,cH,bw,gap);
        if(r.iw<=0||r.ih<=0) return;
        tc.save();
        tc.beginPath(); tc.rect(r.ix,r.iy,r.iw,r.ih); tc.clip();
        tc.drawImage(img,imgX,imgY,dw,dh);
        tc.restore();
        if(bw>0){tc.strokeStyle='#000';tc.lineWidth=bw;tc.strokeRect(r.rx+bw/2,r.ry+bw/2,r.rw-bw,r.rh-bw);}
      });
    } else {
      /* no image: draw numbered placeholders */
      S.panels.forEach(function(p,idx){
        var r=panelPxRect(p,cW,cH,bw,gap);
        tc.fillStyle='#1a1a1a'; tc.fillRect(r.ix,r.iy,r.iw,r.ih);
        tc.fillStyle='#2c2c2c';
        var fs=Math.min(r.iw,r.ih)*0.18;
        tc.font='600 '+fs+'px DM Sans';
        tc.textAlign='center'; tc.textBaseline='middle';
        tc.fillText(String(idx+1), r.ix+r.iw/2, r.iy+r.ih/2);
        if(bw>0){tc.strokeStyle='#000';tc.lineWidth=bw;tc.strokeRect(r.rx+bw/2,r.ry+bw/2,r.rw-bw,r.rh-bw);}
      });
    }
  } else {
    /* individual */
    S.panels.forEach(function(p,idx){
      var r=panelPxRect(p,cW,cH,bw,gap);
      if(r.iw<=0||r.ih<=0) return;
      var img=S.pImages[p.id];
      if(img){
        var st=S.pState[p.id]||{ox:0,oy:0,scale:1};
        tc.save();
        tc.beginPath(); tc.rect(r.ix,r.iy,r.iw,r.ih); tc.clip();
        drawCover(tc,img,r.ix,r.iy,r.iw,r.ih,st.ox*scale,st.oy*scale,st.scale);
        tc.restore();
      } else {
        tc.fillStyle='#1a1a1a'; tc.fillRect(r.ix,r.iy,r.iw,r.ih);
        tc.fillStyle='#2c2c2c';
        var fs=Math.min(r.iw,r.ih)*0.18;
        tc.font='600 '+fs+'px DM Sans';
        tc.textAlign='center'; tc.textBaseline='middle';
        tc.fillText(String(idx+1), r.ix+r.iw/2, r.iy+r.ih/2);
      }
      if(bw>0){tc.strokeStyle='#000';tc.lineWidth=bw;tc.strokeRect(r.rx+bw/2,r.ry+bw/2,r.rw-bw,r.rh-bw);}
    });
  }
}

function render(){
  renderCore(mCtx, mCanvas, 1, true);
  fitCanvas();
  updateEmptyState();
}

/* ==========================================================
   OVERLAY CANVAS  (selection highlight + pen preview)
========================================================== */
function updateOverlay(){
  var dims = getCanvasDims();
  var bw=BORDER_MAP[S.borderKey], gap=GAP_MAP[S.gapKey];
  oCtx.clearRect(0,0,oCanvas.width,oCanvas.height);

  /* selected panel highlight */
  if(S.activeId>=0 && S.mode==='indiv'){
    var p=getPanelById(S.activeId);
    if(p){
      var r=panelPxRect(p,dims.w,dims.h,bw,gap);
      oCtx.strokeStyle='rgba(245,197,24,0.85)';
      oCtx.lineWidth=2.5;
      oCtx.setLineDash([]);
      oCtx.strokeRect(r.ix+1,r.iy+1,r.iw-2,r.ih-2);
    }
  }

  /* pen mode line preview */
  if(S.tool==='pen' && S.iMode==='draw' && S.drawEnd && S.iPanelId>=0){
    var p2=getPanelById(S.iPanelId);
    if(p2){
      var r2=panelPxRect(p2,dims.w,dims.h,bw,gap);
      var x1=S.iStart.cx, y1=S.iStart.cy;
      var x2=S.drawEnd.cx, y2=S.drawEnd.cy;
      var ddx=Math.abs(x2-x1), ddy=Math.abs(y2-y1);
      var isH=ddx>ddy;
      var midX=(x1+x2)/2, midY=(y1+y2)/2;

      var lx1,ly1,lx2,ly2;
      if(isH){
        var sy=Math.max(r2.iy+r2.ih*MIN_RATIO, Math.min(r2.iy+r2.ih*(1-MIN_RATIO), midY));
        lx1=r2.ix; ly1=sy; lx2=r2.ix+r2.iw; ly2=sy;
      } else {
        var sx=Math.max(r2.ix+r2.iw*MIN_RATIO, Math.min(r2.ix+r2.iw*(1-MIN_RATIO), midX));
        lx1=sx; ly1=r2.iy; lx2=sx; ly2=r2.iy+r2.ih;
      }

      /* panel highlight */
      oCtx.fillStyle='rgba(34,211,238,0.07)';
      oCtx.fillRect(r2.ix,r2.iy,r2.iw,r2.ih);

      /* split line */
      oCtx.save();
      oCtx.strokeStyle='rgba(34,211,238,0.95)';
      oCtx.lineWidth=2;
      oCtx.setLineDash([7,5]);
      oCtx.beginPath(); oCtx.moveTo(lx1,ly1); oCtx.lineTo(lx2,ly2); oCtx.stroke();
      oCtx.restore();
    }
  }
}

function updateEmptyState(){
  var hasContent = S.splitImg || Object.keys(S.pImages).length>0;
  emptyEl.style.display = hasContent ? 'none' : 'block';
}

/* ==========================================================
   TOUCH / MOUSE HANDLERS
========================================================== */
mCanvas.addEventListener('touchstart', onTStart, {passive:false});
mCanvas.addEventListener('touchmove',  onTMove,  {passive:false});
mCanvas.addEventListener('touchend',   onTEnd,   {passive:false});
mCanvas.addEventListener('touchcancel',onTEnd,   {passive:false});

mCanvas.addEventListener('mousedown', onMDown);
window.addEventListener('mousemove',  onMMove);
window.addEventListener('mouseup',    onMUp);
mCanvas.addEventListener('mousemove', function(e){
  if(S.iMode) return;
  var pt=toCanvas(e.clientX,e.clientY);
  var p=getPanelAt(pt.cx,pt.cy);
  mCanvas.style.cursor = S.tool==='pen' ? 'crosshair' : (p?'grab':'default');
});

/* -- TOUCH -- */
function onTStart(e){
  e.preventDefault();
  var t0=e.touches[0];
  var pt=toCanvas(t0.clientX,t0.clientY);

  if(e.touches.length===2){
    /* pinch always works in select mode on valid target */
    var panel=null;
    if(S.mode==='indiv') panel=getPanelById(S.activeId);
    var mid=toCanvas((e.touches[0].clientX+e.touches[1].clientX)/2,
                     (e.touches[0].clientY+e.touches[1].clientY)/2);
    S.iMode='pinch';
    S.iStart=mid;
    S.iStartDist=touchDist(e.touches);
    if(S.mode==='split'){
      S.iStartSc=S.splitSt.scale;
      S.iStartOff={ox:S.splitSt.ox,oy:S.splitSt.oy};
    } else if(panel){
      var cs=S.pState[panel.id]||{ox:0,oy:0,scale:1};
      S.iStartSc=cs.scale;
      S.iStartOff={ox:cs.ox,oy:cs.oy};
      S.iPanelId=panel.id;
    }
    return;
  }

  if(S.tool==='pen'){
    var p=getPanelAt(pt.cx,pt.cy);
    if(!p) return;
    S.iMode='draw';
    S.iPanelId=p.id;
    S.iStart={cx:pt.cx,cy:pt.cy};
    S.drawEnd={cx:pt.cx,cy:pt.cy};
    updateOverlay();
  } else {
    startPan(pt.cx,pt.cy);
  }
}

function onTMove(e){
  e.preventDefault();
  if(!S.iMode) return;
  var t0=e.touches[0];

  if(S.iMode==='pinch' && e.touches.length===2){
    var d=touchDist(e.touches);
    var ratio=d/S.iStartDist;
    var mid=toCanvas((e.touches[0].clientX+e.touches[1].clientX)/2,
                     (e.touches[0].clientY+e.touches[1].clientY)/2);
    applyPinch(ratio, mid.cx-S.iStart.cx, mid.cy-S.iStart.cy);
    render(); updateOverlay();
    return;
  }

  var pt=toCanvas(t0.clientX,t0.clientY);

  if(S.iMode==='draw'){
    S.drawEnd={cx:pt.cx,cy:pt.cy};
    updateOverlay();
  } else if(S.iMode==='pan'){
    applyPan(pt.cx,pt.cy);
    render(); updateOverlay();
  }
}

function onTEnd(e){
  e.preventDefault();
  if(S.iMode==='draw'){
    finishDraw();
  }
  if(e.touches.length===0) S.iMode=null;
}

/* -- MOUSE -- */
function onMDown(e){
  if(e.button!==0) return;
  var pt=toCanvas(e.clientX,e.clientY);
  if(S.tool==='pen'){
    var p=getPanelAt(pt.cx,pt.cy);
    if(!p) return;
    S.iMode='draw';
    S.iPanelId=p.id;
    S.iStart={cx:pt.cx,cy:pt.cy};
    S.drawEnd={cx:pt.cx,cy:pt.cy};
    updateOverlay();
  } else {
    startPan(pt.cx,pt.cy);
  }
  e.preventDefault();
}

function onMMove(e){
  if(!S.iMode) return;
  var pt=toCanvas(e.clientX,e.clientY);
  if(S.iMode==='draw'){
    S.drawEnd={cx:pt.cx,cy:pt.cy};
    updateOverlay();
  } else if(S.iMode==='pan'){
    applyPan(pt.cx,pt.cy);
    render(); updateOverlay();
  }
}

function onMUp(e){
  if(S.iMode==='draw') finishDraw();
  S.iMode=null;
  mCanvas.style.cursor = S.tool==='pen'?'crosshair':'default';
}

/* -- PAN/PINCH helpers -- */
function startPan(cx,cy){
  var p=null;
  if(S.mode==='indiv'){
    p=getPanelAt(cx,cy);
    if(!p){setActiveId(-1);return;}
    setActiveId(p.id);
    if(!S.pImages[p.id]) return; /* no image, just select */
    S.iPanelId=p.id;
    var cs=S.pState[p.id]||{ox:0,oy:0,scale:1};
    S.iStartOff={ox:cs.ox,oy:cs.oy};
  } else {
    if(!S.splitImg) return;
    S.iPanelId=-1;
    S.iStartOff={ox:S.splitSt.ox,oy:S.splitSt.oy};
  }
  S.iMode='pan';
  S.iStart={cx:cx,cy:cy};
  mCanvas.style.cursor='grabbing';
}

function applyPan(cx,cy){
  var ddx=cx-S.iStart.cx, ddy=cy-S.iStart.cy;
  if(S.iPanelId<0){
    S.splitSt.ox=S.iStartOff.ox+ddx;
    S.splitSt.oy=S.iStartOff.oy+ddy;
  } else {
    if(!S.pState[S.iPanelId]) S.pState[S.iPanelId]={ox:0,oy:0,scale:1};
    var cs=S.pState[S.iPanelId];
    cs.ox=S.iStartOff.ox+ddx; cs.oy=S.iStartOff.oy+ddy;
  }
}

function applyPinch(ratio, panDx, panDy){
  var newSc=Math.max(1,Math.min(5,S.iStartSc*ratio));
  if(S.iPanelId<0){
    S.splitSt.scale=newSc;
    S.splitSt.ox=S.iStartOff.ox+panDx;
    S.splitSt.oy=S.iStartOff.oy+panDy;
  } else if(S.iPanelId>=0){
    var cs=S.pState[S.iPanelId];
    if(cs){cs.scale=newSc; cs.ox=S.iStartOff.ox+panDx; cs.oy=S.iStartOff.oy+panDy;}
  }
}

/* -- FINISH DRAW (split) -- */
function finishDraw(){
  if(!S.drawEnd||S.iPanelId<0){
    S.drawEnd=null; updateOverlay(); return;
  }
  var dx=S.drawEnd.cx-S.iStart.cx, dy=S.drawEnd.cy-S.iStart.cy;
  var dist=Math.sqrt(dx*dx+dy*dy);
  if(dist < PEN_THRESH){
    /* treat as tap: select panel */
    setActiveId(S.iPanelId);
    S.drawEnd=null; updateOverlay(); return;
  }
  pushHistory();
  splitPanel(S.iPanelId, S.iStart.cx,S.iStart.cy, S.drawEnd.cx,S.drawEnd.cy);
  S.drawEnd=null;
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

/* ==========================================================
   ACTIVE PANEL
========================================================== */
function setActiveId(id){
  S.activeId=id;
  updateOverlay();
  refreshCellGrid();
  updateCellZoomPanel();
}

function updateCellZoomPanel(){
  var zp=document.getElementById('zPanelCell');
  if(!zp) return;
  if(S.mode!=='indiv'||S.activeId<0){zp.style.display='none';return;}
  var cs=S.pState[S.activeId]||{ox:0,oy:0,scale:1};
  document.getElementById('zCellLbl').textContent='コマ'+(panelDisplayIdx(S.activeId)+1)+' ズーム';
  var sldr=document.getElementById('zCell');
  sldr.value=Math.round(cs.scale*100);
  document.getElementById('zCellVal').textContent=cs.scale.toFixed(1)+'x';
  zp.style.display='block';
}

function panelDisplayIdx(id){
  for(var i=0;i<S.panels.length;i++) if(S.panels[i].id===id) return i;
  return 0;
}

/* ==========================================================
   FILE UPLOAD
========================================================== */
var uploadZone=document.getElementById('uploadZone');
uploadZone.addEventListener('dragover',function(e){e.preventDefault();e.stopPropagation();uploadZone.classList.add('drag');});
uploadZone.addEventListener('dragleave',function(e){e.stopPropagation();uploadZone.classList.remove('drag');});
uploadZone.addEventListener('drop',function(e){
  e.preventDefault();e.stopPropagation();uploadZone.classList.remove('drag');
  if(e.dataTransfer&&e.dataTransfer.files.length>0) loadSplitFile(e.dataTransfer.files[0]);
});
fInput.addEventListener('change',function(){
  if(fInput.files&&fInput.files.length>0) loadSplitFile(fInput.files[0]);
});
fInputCell.addEventListener('change',function(){
  if(fInputCell.files&&fInputCell.files.length>0&&S.pendCell>=0){
    loadCellFile(fInputCell.files[0],S.pendCell);
  }
});

function loadSplitFile(file){
  if(!file.type.startsWith('image/')) return;
  readImg(file,function(img){
    S.splitImg=img;
    S.splitSt={ox:0,oy:0,scale:1};
    document.getElementById('zPanelSplit').style.display='block';
    document.getElementById('zGlobal').value=100;
    document.getElementById('zGlobalVal').textContent='1.0x';
    updateSaveBtn();
    if(!S.hintShown){S.hintShown=true;showToast('ドラッグで位置調整 / ピンチで拡大縮小');}
    requestAnimationFrame(function(){render();updateOverlay();});
    fInput.value='';
  });
}

function loadCellFile(file,panelId){
  if(!file.type.startsWith('image/')) return;
  readImg(file,function(img){
    S.pImages[panelId]=img;
    S.pState[panelId]={ox:0,oy:0,scale:1};
    setActiveId(panelId);
    refreshCellGrid();
    updateSaveBtn();
    if(!S.hintShown){S.hintShown=true;showToast('ドラッグで位置調整 / ピンチで拡大縮小');}
    requestAnimationFrame(function(){render();updateOverlay();});
    fInputCell.value='';
  });
}

function readImg(file,cb){
  var img=new Image();
  img.onload=function(){cb(img);};
  img.onerror=function(){console.warn('ComicFrame: load error',file.name);};
  img.src=URL.createObjectURL(file);
}

/* ==========================================================
   CELL GRID (individual mode)
========================================================== */
function refreshCellGrid(){
  var grid=document.getElementById('cellGrid');
  if(!grid) return;
  grid.innerHTML='';
  S.panels.forEach(function(p,i){
    var slot=document.createElement('div');
    var hasPic=!!S.pImages[p.id];
    var isSel=p.id===S.activeId;
    slot.className='cslot'+(hasPic?' has':'')+(isSel?' sel':'');
    if(hasPic){
      var thumb=document.createElement('img');
      thumb.src=S.pImages[p.id].src;
      slot.appendChild(thumb);
    }
    var lbl=document.createElement('span');
    lbl.textContent='コマ'+(i+1);
    slot.appendChild(lbl);
    slot.onclick=(function(pid){return function(){
      S.pendCell=pid;
      setActiveId(pid);
      fInputCell.click();
    };})(p.id);
    grid.appendChild(slot);
  });
  updateCellZoomPanel();
}

/* ==========================================================
   ZOOM CONTROLS
========================================================== */
function onZoomGlobal(v){
  S.splitSt.scale=parseInt(v)/100;
  document.getElementById('zGlobalVal').textContent=S.splitSt.scale.toFixed(1)+'x';
  requestAnimationFrame(function(){render();});
}
function resetGlobal(){
  S.splitSt={ox:0,oy:0,scale:1};
  document.getElementById('zGlobal').value=100;
  document.getElementById('zGlobalVal').textContent='1.0x';
  requestAnimationFrame(function(){render();});
}

function onZoomCell(v){
  if(S.activeId<0) return;
  if(!S.pState[S.activeId]) S.pState[S.activeId]={ox:0,oy:0,scale:1};
  S.pState[S.activeId].scale=parseInt(v)/100;
  document.getElementById('zCellVal').textContent=S.pState[S.activeId].scale.toFixed(1)+'x';
  requestAnimationFrame(function(){render();});
}
function resetActiveCell(){
  if(S.activeId<0) return;
  S.pState[S.activeId]={ox:0,oy:0,scale:1};
  document.getElementById('zCell').value=100;
  document.getElementById('zCellVal').textContent='1.0x';
  requestAnimationFrame(function(){render();});
}
function clearActiveCell(){
  if(S.activeId<0) return;
  delete S.pImages[S.activeId];
  S.pState[S.activeId]={ox:0,oy:0,scale:1};
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){render();updateOverlay();});
}

/* ==========================================================
   SETTINGS
========================================================== */
function setTool(t){
  S.tool=t;
  document.getElementById('btnSelect').classList.toggle('on', t==='select');
  document.getElementById('btnSelect').classList.remove('pen-on');
  document.getElementById('btnPen').classList.toggle('pen-on', t==='pen');
  document.getElementById('btnPen').classList.toggle('on', false);
  mCanvas.style.cursor = t==='pen'?'crosshair':'default';
  if(t==='pen'){
    penBadge.classList.add('show');
    clearTimeout(penBadgeTimer);
    penBadgeTimer=setTimeout(function(){penBadge.classList.remove('show');},3000);
  } else {
    penBadge.classList.remove('show');
  }
}

function setMode(m){
  S.mode=m;
  document.getElementById('btnMSplit').classList.toggle('on',m==='split');
  document.getElementById('btnMIndiv').classList.toggle('on',m==='indiv');
  document.getElementById('pSplit').style.display=m==='split'?'block':'none';
  document.getElementById('pIndiv').style.display=m==='indiv'?'block':'none';
  if(m==='indiv') refreshCellGrid();
  S.activeId=-1;
  updateOverlay();
  updateSaveBtn();
  requestAnimationFrame(function(){render();});
}

function setBorder(k){
  S.borderKey=k;
  ['thin','mid','thick'].forEach(function(id){
    document.getElementById('bw-'+id).classList.toggle('on',id===k);
  });
  requestAnimationFrame(function(){render();updateOverlay();});
}

function setGap(k){
  S.gapKey=k;
  ['none','mid','wide'].forEach(function(id){
    document.getElementById('gap-'+id).classList.toggle('on',id===k);
  });
  requestAnimationFrame(function(){render();updateOverlay();});
}

function setQuality(q){
  S.quality=q;
  ['std','hi'].forEach(function(id){
    document.getElementById('q-'+id).classList.toggle('on',id===q);
  });
}

function updateSaveBtn(){
  var hasContent=S.splitImg||Object.keys(S.pImages).length>0;
  btnSave.disabled=!hasContent;
}

/* ==========================================================
   TABS
========================================================== */
function switchTab(id){
  document.querySelectorAll('.tab').forEach(function(t){
    t.classList.toggle('on', t.getAttribute('data-tc')===id);
  });
  document.querySelectorAll('.tc').forEach(function(c){
    c.classList.toggle('on',c.id===id);
  });
}

/* ==========================================================
   TOASTS
========================================================== */
function showToast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){toastEl.classList.remove('show');},3000);
}

/* ==========================================================
   EXPORT / SHARE
========================================================== */
function saveImage(){
  var scale=QUAL_MAP[S.quality];
  var offCanvas=document.createElement('canvas');
  var offCtx=offCanvas.getContext('2d');
  renderCore(offCtx,offCanvas,scale,false);

  offCanvas.toBlob(function(blob){
    if(!blob) return;
    var file=new File([blob],'comicframe.png',{type:'image/png'});
    /* Web Share API: try sharing as file first (iOS/Android photo apps) */
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({
        title:'ComicFrame',
        files:[file]
      }).catch(function(err){
        if(err.name!=='AbortError') fallbackDL(blob);
      });
    } else if(navigator.share){
      /* Some platforms support text share but not files - try URL share of data */
      fallbackDL(blob);
    } else {
      fallbackDL(blob);
    }
  },'image/png');
}

function fallbackDL(blob){
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;
  a.download='comicframe_'+Date.now()+'.png';
  a.click();
  setTimeout(function(){URL.revokeObjectURL(url);},5000);
}

/* ==========================================================
   BOOT
========================================================== */
render();
updateOverlay();
updateSaveBtn();
</script>
</body>
</html>
