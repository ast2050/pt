<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ComicFrame</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f8f8;--surface:#ffffff;--panel:#fafafa;
  --text:#222222;--muted:#888888;--border:#e0e0e0;
  --accent:#333333;--accent-light:#555555;
  --pen:#0066cc;--shadow:0 1px 3px rgba(0,0,0,0.06);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'Inter',sans-serif;font-size:14px;
  -webkit-tap-highlight-color:transparent;touch-action:none;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

.app{display:flex;flex-direction:column;height:100dvh}

/* ---- TOP BAR ---- */
.topbar{
  flex-shrink:0;height:50px;display:flex;align-items:center;
  justify-content:space-between;padding:0 16px;
  background:var(--surface);border-bottom:1px solid var(--border);
}
.logo{font-size:18px;font-weight:600;letter-spacing:-0.02em;color:var(--text)}
.logo small{font-size:11px;color:var(--muted);font-weight:400;margin-left:8px}
.tools{display:flex;gap:6px}
.tbtn{
  padding:7px 14px;border:1px solid var(--border);border-radius:4px;
  background:var(--surface);color:var(--text);font-size:12px;font-weight:500;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.tbtn:hover{background:var(--panel);border-color:var(--accent-light)}
.tbtn:active{opacity:.7}
.tbtn.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.tbtn.pen-on{background:var(--pen);color:#fff;border-color:var(--pen)}
.tbtn:disabled{opacity:.3;pointer-events:none}

/* ---- PREVIEW ---- */
.preview-section{
  flex:1;min-height:0;display:flex;align-items:center;justify-content:center;
  background:var(--bg);position:relative;overflow:hidden;
}
#cWrap{position:relative;display:inline-block;box-shadow:var(--shadow)}
#mCanvas{display:block;touch-action:none;background:#fff}
#oCanvas{position:absolute;top:0;left:0;pointer-events:none}

.pen-badge,.toast{
  position:absolute;font-size:11px;font-weight:500;
  padding:6px 14px;border-radius:20px;pointer-events:none;
  opacity:0;transition:opacity .25s;white-space:nowrap;
  background:rgba(0,0,0,.75);color:#fff;
}
.pen-badge{top:12px;left:50%;transform:translateX(-50%)}
.pen-badge.show{opacity:1}
.toast{bottom:12px;left:50%;transform:translateX(-50%)}
.toast.show{opacity:1}

.empty-state{
  position:absolute;text-align:center;color:var(--muted);pointer-events:none
}
.empty-state .eico{font-size:40px;opacity:.1;margin-bottom:12px}
.empty-state p{font-size:12px;line-height:1.8}

/* ---- CONTROLS ---- */
.ctrl{
  flex-shrink:0;background:var(--surface);
  border-top:1px solid var(--border);display:flex;flex-direction:column;
}
.tabs{display:flex;flex-shrink:0;border-bottom:1px solid var(--border)}
.tab{
  flex:1;padding:11px 4px;border:none;background:transparent;
  color:var(--muted);font-size:11px;font-weight:500;cursor:pointer;
  border-bottom:2px solid transparent;position:relative;bottom:-1px;
  transition:all .15s;letter-spacing:0.02em;
}
.tab.on{color:var(--accent);border-bottom-color:var(--accent)}
.tc{display:none;overflow-y:auto;padding:14px 16px;flex:1}
.tc.on{display:block}
.tc::-webkit-scrollbar{width:3px}
.tc::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* ---- TEMPLATE STRIP ---- */
.tmpl-strip{
  display:flex;gap:10px;overflow-x:auto;padding:2px 0 8px;
  -webkit-overflow-scrolling:touch;
}
.tmpl-strip::-webkit-scrollbar{height:2px}
.tmpl-strip::-webkit-scrollbar-thumb{background:var(--border)}
.tcard{flex-shrink:0;cursor:pointer;text-align:center}
.tthumb{
  border-radius:4px;border:1.5px solid var(--border);overflow:hidden;
  background:#fff;transition:border-color .15s;
}
.tcard.on .tthumb{border-color:var(--accent)}
.tthumb svg{display:block}
.tname{
  font-size:9px;color:var(--muted);margin-top:4px;line-height:1.4;font-weight:500
}
.tcard.on .tname{color:var(--accent)}

/* ---- MODE ROW ---- */
.mrow{
  display:flex;background:var(--panel);border-radius:4px;
  padding:3px;gap:3px;margin-bottom:12px;
}
.mbtn{
  flex:1;padding:8px 6px;border:none;border-radius:3px;background:transparent;
  color:var(--text);font-size:11px;font-weight:500;cursor:pointer;
  transition:all .15s;text-align:center;line-height:1.4;
}
.mbtn.on{background:var(--accent);color:#fff}

/* ---- UPLOAD LABEL ---- */
.ulbl{
  display:flex;align-items:center;justify-content:center;gap:8px;
  border:1.5px dashed var(--border);border-radius:4px;padding:12px;
  cursor:pointer;color:var(--muted);font-size:12px;font-weight:500;
  transition:all .15s;user-select:none;-webkit-user-select:none;
}
.ulbl:hover,.ulbl.drag{border-color:var(--accent);color:var(--accent)}
#fInput,#fInputCell{display:none}

/* ---- CELL GRID ---- */
.cgrid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(58px,1fr));
  gap:6px;margin-top:8px;
}
.cslot{
  border:1.5px dashed var(--border);border-radius:4px;padding:6px 4px;
  text-align:center;cursor:pointer;font-size:9px;color:var(--muted);
  font-weight:500;transition:all .15s;user-select:none;-webkit-user-select:none;
}
.cslot.has{border-color:#ccc;color:var(--text)}
.cslot.sel{border-color:var(--accent);color:var(--accent)}
.cslot img{
  width:100%;height:34px;object-fit:cover;border-radius:3px;
  display:block;margin-bottom:3px;
}

/* ---- ZOOM ROW ---- */
.zrow{display:flex;align-items:center;gap:10px;margin-top:8px}
.zslider{
  flex:1;-webkit-appearance:none;appearance:none;height:3px;
  border-radius:2px;background:var(--border);outline:none;cursor:pointer;
}
.zslider::-webkit-slider-thumb{
  -webkit-appearance:none;width:16px;height:16px;border-radius:50%;
  background:var(--accent);cursor:pointer;
}
.zslider::-moz-range-thumb{
  width:16px;height:16px;border-radius:50%;
  background:var(--accent);cursor:pointer;border:none;
}
.zval{font-size:11px;color:var(--muted);min-width:36px;text-align:right;font-weight:500}

/* ---- QUAD SELECT (4 options) ---- */
.quad{
  display:grid;grid-template-columns:repeat(4,1fr);
  background:var(--panel);border-radius:4px;padding:3px;gap:3px;
}
.qbtn{
  padding:6px 2px;border:none;border-radius:3px;background:transparent;
  color:var(--text);font-size:10px;font-weight:500;cursor:pointer;
  transition:all .15s;text-align:center;line-height:1.4;
}
.qbtn.on{background:var(--accent);color:#fff}

/* ---- DUAL TOGGLE (2 options) ---- */
.dual{
  display:flex;background:var(--panel);border-radius:4px;
  padding:3px;gap:3px;
}
.dbtn{
  flex:1;padding:7px 8px;border:none;border-radius:3px;background:transparent;
  color:var(--text);font-size:11px;font-weight:500;cursor:pointer;
  transition:all .15s;text-align:center;
}
.dbtn.on{background:var(--accent);color:#fff}

/* ---- FIELD LABEL ---- */
.fl{
  font-size:10px;font-weight:600;color:var(--muted);
  letter-spacing:0.04em;text-transform:uppercase;margin:12px 0 6px;
}
.fl:first-child{margin-top:0}

/* ---- SAVE BUTTON ---- */
.savebtn{
  width:100%;padding:13px;border:none;border-radius:4px;
  background:var(--accent);color:#fff;font-size:14px;font-weight:600;
  cursor:pointer;transition:all .15s;margin-top:12px;letter-spacing:0.02em;
}
.savebtn:hover:not(:disabled){background:var(--accent-light)}
.savebtn:disabled{background:var(--panel);color:var(--muted);cursor:not-allowed}
.savenote{
  font-size:10px;color:var(--muted);text-align:center;
  margin-top:8px;line-height:1.6;
}

.smallbtn{
  padding:6px 12px;border:1px solid var(--border);border-radius:4px;
  background:var(--surface);color:var(--text);font-size:10px;font-weight:500;
  cursor:pointer;transition:all .15s;
}
.smallbtn:hover{background:var(--panel);border-color:var(--accent-light)}
</style>
</head>
<body>
<div class="app">

  <!-- ════ TOP BAR ════ -->
  <div class="topbar">
    <div class="logo">ComicFrame <small>v5</small></div>
    <div class="tools">
      <button class="tbtn on" id="btnSelect" onclick="setTool('select')">選択</button>
      <button class="tbtn" id="btnPen" onclick="setTool('pen')">ペン</button>
      <button class="tbtn" id="btnUndo" onclick="undo()" disabled>戻す</button>
    </div>
  </div>

  <!-- ════ PREVIEW ════ -->
  <div class="preview-section" id="previewSection">
    <div id="emptyState" class="empty-state">
      <div class="eico">&#127902;</div>
      <p>写真を追加してコマに配置<br>ペンモードで自由に分割</p>
    </div>
    <div id="cWrap">
      <canvas id="mCanvas"></canvas>
      <canvas id="oCanvas"></canvas>
    </div>
    <div class="pen-badge" id="penBadge">ペンモード: ドラッグして分割</div>
    <div class="toast" id="toast">ドラッグで移動 / ピンチで拡大縮小</div>
  </div>

  <!-- ════ CONTROLS ════ -->
  <div class="ctrl" id="ctrl">

    <div class="tabs">
      <button class="tab on" data-tc="tc1" onclick="switchTab('tc1')">TEMPLATE</button>
      <button class="tab" data-tc="tc2" onclick="switchTab('tc2')">PHOTO</button>
      <button class="tab" data-tc="tc3" onclick="switchTab('tc3')">FRAME</button>
      <button class="tab" data-tc="tc4" onclick="switchTab('tc4')">SAVE</button>
    </div>

    <!-- ── TAB 1: TEMPLATE ── -->
    <div class="tc on" id="tc1">
      <div class="fl">Layout Templates</div>
      <div class="tmpl-strip" id="tmplStrip"></div>
      <p style="font-size:10px;color:var(--muted);margin-top:8px;line-height:1.6">
        ペンモードで選択したコマを自由に分割できます
      </p>
    </div>

    <!-- ── TAB 2: PHOTO ── -->
    <div class="tc" id="tc2">
      <div class="fl">Mode</div>
      <div class="mrow">
        <button class="mbtn on" id="btnMSplit" onclick="setMode('split')">
          Bleed<br><span style="font-size:9px;opacity:.8">1枚を全面配置</span>
        </button>
        <button class="mbtn" id="btnMIndiv" onclick="setMode('indiv')">
          Individual<br><span style="font-size:9px;opacity:.8">コマ別に配置</span>
        </button>
      </div>

      <!-- SPLIT MODE -->
      <div id="pSplit">
        <label class="ulbl" id="uploadZone" for="fInput">
          &#128194; Select or Drop Photo
        </label>
        <div id="zPanelSplit" style="display:none;margin-top:10px">
          <div class="fl">Global Zoom</div>
          <div class="zrow">
            <span style="font-size:12px">&#128269;</span>
            <input type="range" class="zslider" id="zGlobal" min="100" max="500" value="100"
                   oninput="onZoomGlobal(this.value)">
            <span class="zval" id="zGlobalVal">1.0x</span>
          </div>
          <button class="smallbtn" style="margin-top:6px" onclick="resetGlobal()">Reset</button>
        </div>
      </div>

      <!-- INDIVIDUAL MODE -->
      <div id="pIndiv" style="display:none">
        <div class="fl">Tap Panel to Assign Photo</div>
        <div class="cgrid" id="cellGrid"></div>
        <div id="zPanelCell" style="display:none;margin-top:10px">
          <div class="fl" id="zCellLbl">Panel 1 Zoom</div>
          <div class="zrow">
            <span style="font-size:12px">&#128269;</span>
            <input type="range" class="zslider" id="zCell" min="100" max="500" value="100"
                   oninput="onZoomCell(this.value)">
            <span class="zval" id="zCellVal">1.0x</span>
          </div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="smallbtn" onclick="resetActiveCell()">Reset</button>
            <button class="smallbtn" onclick="clearActiveCell()">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ── TAB 3: FRAME ── -->
    <div class="tc" id="tc3">
      <div class="fl">Frame Color</div>
      <div class="dual">
        <button class="dbtn on" id="fc-black" onclick="setFrameColor('black')">Black</button>
        <button class="dbtn" id="fc-white" onclick="setFrameColor('white')">White</button>
      </div>

      <div class="fl">Outer Border</div>
      <div class="quad">
        <button class="qbtn" id="ob-none" onclick="setOuter('none')">None</button>
        <button class="qbtn on" id="ob-thin" onclick="setOuter('thin')">Thin</button>
        <button class="qbtn" id="ob-mid" onclick="setOuter('mid')">Mid</button>
        <button class="qbtn" id="ob-thick" onclick="setOuter('thick')">Thick</button>
      </div>

      <div class="fl">Gutter (Gap)</div>
      <div class="quad">
        <button class="qbtn on" id="gu-none" onclick="setGutter('none')">None</button>
        <button class="qbtn" id="gu-narrow" onclick="setGutter('narrow')">Narrow</button>
        <button class="qbtn" id="gu-mid" onclick="setGutter('mid')">Mid</button>
        <button class="qbtn" id="gu-wide" onclick="setGutter('wide')">Wide</button>
      </div>

      <div class="fl">Line Weight</div>
      <div class="quad">
        <button class="qbtn" id="lw-none" onclick="setLine('none')">None</button>
        <button class="qbtn" id="lw-thin" onclick="setLine('thin')">Thin</button>
        <button class="qbtn on" id="lw-mid" onclick="setLine('mid')">Mid</button>
        <button class="qbtn" id="lw-thick" onclick="setLine('thick')">Thick</button>
      </div>
    </div>

    <!-- ── TAB 4: SAVE ── -->
    <div class="tc" id="tc4">
      <div class="fl">Export Quality</div>
      <div class="dual">
        <button class="dbtn on" id="q-std" onclick="setQuality('std')">
          Standard<br><span style="font-size:9px;opacity:.8">1x</span>
        </button>
        <button class="dbtn" id="q-hi" onclick="setQuality('hi')">
          High<br><span style="font-size:9px;opacity:.8">3x</span>
        </button>
      </div>
      <button class="savebtn" id="btnSave" onclick="saveImage()" disabled>
        &#11015;&#xFE0E; Save Image
      </button>
      <div class="savenote">
        Mobile: Direct save to Photos<br>Desktop: PNG download
      </div>
    </div>

  </div><!-- /ctrl -->
</div>

<input type="file" id="fInput" accept="image/*">
<input type="file" id="fInputCell" accept="image/*">

<script>
/* ==========================================================
   TEMPLATES
========================================================== */
var TEMPLATES = [
  {
    id:'blank', name:'Blank', aspect:0.75,
    cells:[{x:0,y:0,w:1,h:1}],
    svgW:60, svgH:80,
    svgCells:'<rect x="2" y="2" width="56" height="76" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
  },
  {
    id:'manga6', name:'6-Panel', aspect:0.68,
    cells:[
      {x:0.59,y:0.00,w:0.41,h:0.39},
      {x:0.37,y:0.00,w:0.22,h:0.39},
      {x:0.00,y:0.00,w:0.37,h:0.39},
      {x:0.00,y:0.39,w:1.00,h:0.21},
      {x:0.50,y:0.60,w:0.50,h:0.40},
      {x:0.00,y:0.60,w:0.50,h:0.40}
    ],
    svgW:60, svgH:88,
    svgCells:'<rect x="2" y="2" width="21" height="31" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="25" y="2" width="12" height="31" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="39" y="2" width="19" height="31" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="35" width="56" height="17" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="54" width="26" height="32" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="30" y="54" width="28" height="32" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
  },
  {
    id:'4koma', name:'4-Panel', aspect:0.60,
    cells:[
      {x:0,y:0.00,w:1,h:0.25},{x:0,y:0.25,w:1,h:0.25},
      {x:0,y:0.50,w:1,h:0.25},{x:0,y:0.75,w:1,h:0.25}
    ],
    svgW:60, svgH:100,
    svgCells:'<rect x="2" y="2"  width="56" height="21" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="26" width="56" height="21" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="50" width="56" height="21" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="74" width="56" height="24" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
  },
  {
    id:'dramatic', name:'Dramatic', aspect:0.80,
    cells:[
      {x:0,y:0,w:1,h:0.5},
      {x:0,y:0.5,w:0.5,h:0.5},
      {x:0.5,y:0.5,w:0.5,h:0.5}
    ],
    svgW:60, svgH:75,
    svgCells:'<rect x="2" y="2"  width="56" height="33" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="2" y="38" width="26" height="35" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="32" y="38" width="26" height="35" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
  },
  {
    id:'spread', name:'Spread', aspect:1.40,
    cells:[
      {x:0,y:0,w:0.5,h:1},
      {x:0.5,y:0,w:0.5,h:1}
    ],
    svgW:80, svgH:57,
    svgCells:'<rect x="2" y="2" width="35" height="53" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
      +'<rect x="43" y="2" width="35" height="53" fill="#e8e8e8" stroke="#bbb" stroke-width="1" rx="1"/>'
  }
];

/* ==========================================================
   CONSTANTS
========================================================== */
var OUTER_MAP  = {none:0,  thin:3,  mid:8,  thick:16};
var GUTTER_MAP = {none:0,  narrow:5, mid:12, wide:22};
var LINE_MAP   = {none:0,  thin:2,  mid:5,  thick:10};
var QUAL_MAP   = {std:1,   hi:3};
var BASE_H     = 900;
var MIN_RATIO  = 0.08;
var PEN_THRESH = 12;

/* ==========================================================
   STATE
========================================================== */
var S = {
  tmplIdx:    1,
  mode:       'split',
  tool:       'select',

  panels:     [],
  history:    [],
  pImages:    {},
  pState:     {},
  nextId:     0,

  splitImg:   null,
  splitSt:    {ox:0, oy:0, scale:1},

  activeId:   -1,
  pendCell:   -1,

  frameColor: 'black',
  outerKey:   'thin',
  gutterKey:  'none',
  lineKey:    'mid',
  quality:    'std',

  iMode:      null,
  iPanelId:   -1,
  iStart:     null,
  iStartOff:  null,
  iStartSc:   1,
  iStartDist: 0,
  drawEnd:    null,

  hintShown:  false
};

/* ==========================================================
   DOM REFS
========================================================== */
var mCanvas = document.getElementById('mCanvas');
var oCanvas = document.getElementById('oCanvas');
var mCtx = mCanvas.getContext('2d');
var oCtx = oCanvas.getContext('2d');
var cWrap = document.getElementById('cWrap');
var prevSec = document.getElementById('previewSection');
var emptyEl = document.getElementById('emptyState');
var penBadge = document.getElementById('penBadge');
var toastEl = document.getElementById('toast');
var btnUndo = document.getElementById('btnUndo');
var btnSave = document.getElementById('btnSave');
var fInput = document.getElementById('fInput');
var fInputCell = document.getElementById('fInputCell');
var ctrl = document.getElementById('ctrl');

var toastTimer = null;
var penBadgeTimer = null;

/* ==========================================================
   INIT
========================================================== */
document.addEventListener('dragover', function(e){e.preventDefault();});
document.addEventListener('drop', function(e){e.preventDefault();});

buildTemplateStrip();
loadTemplate(1, false);
syncCtrlHeight();

window.addEventListener('resize', function(){
  syncCtrlHeight();
  fitCanvas();
});

/* ==========================================================
   TEMPLATE STRIP
========================================================== */
function buildTemplateStrip(){
  var strip = document.getElementById('tmplStrip');
  strip.innerHTML = '';
  TEMPLATES.forEach(function(t, i){
    var card = document.createElement('div');
    card.className = 'tcard' + (i === S.tmplIdx ? ' on' : '');
    card.id = 'tc_' + i;
    var w = t.svgW, h = t.svgH;
    var displayH = 64, displayW = Math.round(displayH * (w / h));
    card.innerHTML =
      '<div class="tthumb" style="width:' + displayW + 'px;height:' + displayH + 'px">'
      + '<svg width="' + displayW + '" height="' + displayH + '" viewBox="0 0 ' + w + ' ' + h + '" fill="none">'
      + '<rect width="' + w + '" height="' + h + '" fill="#fff"/>'
      + t.svgCells
      + '</svg></div>'
      + '<div class="tname">' + t.name + '</div>';
    card.onclick = (function(idx){ return function(){ loadTemplate(idx, true); }; })(i);
    strip.appendChild(card);
  });
}

/* ==========================================================
   PANEL MANAGEMENT
========================================================== */
function loadTemplate(idx, resetImages){
  S.tmplIdx = idx;
  var tmpl = TEMPLATES[idx];
  S.nextId = 0;
  S.panels = tmpl.cells.map(function(c){
    return {id:S.nextId++, x:c.x, y:c.y, w:c.w, h:c.h};
  });
  S.history = [];
  if(resetImages){
    S.pImages = {};
    S.pState = {};
    S.splitImg = null;
    S.splitSt = {ox:0, oy:0, scale:1};
  }
  S.activeId = -1;
  S.iMode = null;
  document.querySelectorAll('.tcard').forEach(function(c, i){
    c.classList.toggle('on', i === idx);
  });
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function getPanelById(id){
  for(var i = 0; i < S.panels.length; i++)
    if(S.panels[i].id === id) return S.panels[i];
  return null;
}

function getPanelAt(cx, cy){
  var dims = getCanvasDims();
  var outer = OUTER_MAP[S.outerKey];
  var gutter = GUTTER_MAP[S.gutterKey];
  var line = LINE_MAP[S.lineKey];
  for(var i = S.panels.length - 1; i >= 0; i--){
    var r = panelPxRect(S.panels[i], dims.w, dims.h, outer, gutter, line);
    if(cx >= r.rx && cx <= r.rx + r.rw && cy >= r.ry && cy <= r.ry + r.rh)
      return S.panels[i];
  }
  return null;
}

function panelPxRect(panel, cW, cH, outer, gutter, line){
  var eps = 0.004;
  var workW = cW - 2 * outer;
  var workH = cH - 2 * outer;
  var rx = outer + panel.x * workW;
  var ry = outer + panel.y * workH;
  var rw = panel.w * workW;
  var rh = panel.h * workH;

  if(gutter > 0){
    var atL = panel.x < eps;
    var atT = panel.y < eps;
    var atR = panel.x + panel.w > 1 - eps;
    var atB = panel.y + panel.h > 1 - eps;
    var gl = atL ? 0 : gutter / 2;
    var gt = atT ? 0 : gutter / 2;
    var gr = atR ? 0 : gutter / 2;
    var gb = atB ? 0 : gutter / 2;
    rx += gl; ry += gt; rw -= (gl + gr); rh -= (gt + gb);
  }

  var ix = rx + line;
  var iy = ry + line;
  var iw = rw - 2 * line;
  var ih = rh - 2 * line;

  return {rx:rx, ry:ry, rw:rw, rh:rh, ix:ix, iy:iy, iw:iw, ih:ih};
}

function pushHistory(){
  S.history.push({
    panels: S.panels.map(function(p){ return {id:p.id, x:p.x, y:p.y, w:p.w, h:p.h}; }),
    pImages: Object.assign({}, S.pImages),
    pState: JSON.parse(JSON.stringify(S.pState)),
    nextId: S.nextId
  });
  if(S.history.length > 12) S.history.shift();
  syncUndoBtn();
}

function undo(){
  if(!S.history.length) return;
  var prev = S.history.pop();
  S.panels = prev.panels;
  S.pImages = prev.pImages;
  S.pState = prev.pState;
  S.nextId = prev.nextId;
  S.activeId = -1;
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function syncUndoBtn(){
  btnUndo.disabled = S.history.length === 0;
}

function splitPanel(panelId, x1, y1, x2, y2){
  var panel = getPanelById(panelId);
  if(!panel) return;

  var dims = getCanvasDims();
  var dx = x2 - x1, dy = y2 - y1;
  var isH = Math.abs(dx) > Math.abs(dy);

  var outer = OUTER_MAP[S.outerKey];
  var gutter = GUTTER_MAP[S.gutterKey];
  var line = LINE_MAP[S.lineKey];
  var r = panelPxRect(panel, dims.w, dims.h, outer, gutter, line);

  var mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
  var idA = S.nextId++, idB = S.nextId++;
  var pA, pB;

  if(isH){
    var sy = Math.max(r.ry + r.rh * MIN_RATIO, Math.min(r.ry + r.rh * (1 - MIN_RATIO), my));
    var workH = dims.h - 2 * outer;
    var ratio = (sy - r.ry) / r.rh;
    pA = {id:idA, x:panel.x, y:panel.y, w:panel.w, h:panel.h * ratio};
    pB = {id:idB, x:panel.x, y:panel.y + panel.h * ratio, w:panel.w, h:panel.h * (1 - ratio)};
  } else {
    var sx = Math.max(r.rx + r.rw * MIN_RATIO, Math.min(r.rx + r.rw * (1 - MIN_RATIO), mx));
    var workW = dims.w - 2 * outer;
    var ratio = (sx - r.rx) / r.rw;
    pA = {id:idA, x:panel.x, y:panel.y, w:panel.w * ratio, h:panel.h};
    pB = {id:idB, x:panel.x + panel.w * ratio, y:panel.y, w:panel.w * (1 - ratio), h:panel.h};
  }

  var parentImg = S.pImages[panelId];
  var parentSt = S.pState[panelId] || {ox:0, oy:0, scale:1};
  if(parentImg){
    S.pImages[idA] = parentImg;
    S.pImages[idB] = parentImg;
  }
  S.pState[idA] = {ox:parentSt.ox, oy:parentSt.oy, scale:parentSt.scale};
  S.pState[idB] = {ox:parentSt.ox, oy:parentSt.oy, scale:parentSt.scale};

  var idx = S.panels.findIndex(function(p){ return p.id === panelId; });
  if(idx < 0) return;
  S.panels.splice(idx, 1, pA, pB);

  delete S.pImages[panelId];
  delete S.pState[panelId];

  S.activeId = idA;
}

/* ==========================================================
   CANVAS SIZING
========================================================== */
function getCanvasDims(){
  var tmpl = TEMPLATES[S.tmplIdx];
  return {w:Math.round(BASE_H * tmpl.aspect), h:BASE_H};
}

function fitCanvas(){
  var dims = getCanvasDims();
  var avW = prevSec.clientWidth - 16;
  var avH = prevSec.clientHeight - 16;
  if(avW <= 0 || avH <= 0) return;
  var sc = Math.min(avW / dims.w, avH / dims.h, 1);
  var dw = Math.round(dims.w * sc), dh = Math.round(dims.h * sc);
  mCanvas.style.width = dw + 'px';
  mCanvas.style.height = dh + 'px';
  oCanvas.style.width = dw + 'px';
  oCanvas.style.height = dh + 'px';
  oCanvas.width = dims.w;
  oCanvas.height = dims.h;
}

function syncCtrlHeight(){
  var ctrlH = Math.min(Math.max(Math.round(window.innerHeight * 0.36), 220), 260);
  ctrl.style.height = ctrlH + 'px';
}

/* ==========================================================
   COORDINATE HELPERS
========================================================== */
function toCanvas(clientX, clientY){
  var r = mCanvas.getBoundingClientRect();
  if(!r.width) return {cx:0, cy:0};
  return {
    cx:(clientX - r.left) * (mCanvas.width / r.width),
    cy:(clientY - r.top) * (mCanvas.height / r.height)
  };
}

function touchDist(touches){
  var dx = touches[0].clientX - touches[1].clientX;
  var dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

/* ==========================================================
   RENDERING
========================================================== */
function drawCover(tc, img, ix, iy, iw, ih, ox, oy, sc){
  if(!img || iw <= 0 || ih <= 0) return;
  var ia = img.naturalWidth / img.naturalHeight;
  var ca = iw / ih;
  var bw, bh;
  if(ia > ca){ bh = ih; bw = ih * ia; }
  else{ bw = iw; bh = iw / ia; }
  var dw = bw * sc, dh = bh * sc;
  var mox = Math.max(0, (dw - iw) / 2);
  var moy = Math.max(0, (dh - ih) / 2);
  var ox2 = Math.max(-mox, Math.min(mox, ox));
  var oy2 = Math.max(-moy, Math.min(moy, oy));
  tc.drawImage(img, ix + iw / 2 - dw / 2 + ox2, iy + ih / 2 - dh / 2 + oy2, dw, dh);
}

function renderCore(tc, tCanvas, scale){
  var dims = getCanvasDims();
  var cW = dims.w * scale;
  var cH = dims.h * scale;

  var outer = OUTER_MAP[S.outerKey] * scale;
  var gutter = GUTTER_MAP[S.gutterKey] * scale;
  var line = LINE_MAP[S.lineKey] * scale;
  
  /* Frame color is used for ALL frame elements */
  var frameColor = S.frameColor === 'white' ? '#ffffff' : '#000000';
  /* Placeholder colors for visibility */
  var placeholderBg = S.frameColor === 'white' ? '#f5f5f5' : '#1a1a1a';
  var placeholderFg = S.frameColor === 'white' ? '#cccccc' : '#333333';

  tCanvas.width = cW;
  tCanvas.height = cH;

  /* Fill entire canvas with frame color */
  tc.fillStyle = frameColor;
  tc.fillRect(0, 0, cW, cH);

  if(S.mode === 'split'){
    if(S.splitImg){
      var img = S.splitImg;
      var st = S.splitSt;
      var workW = cW - 2 * outer;
      var workH = cH - 2 * outer;
      var ia = img.naturalWidth / img.naturalHeight;
      var ca = workW / workH;
      var bw2, bh2;
      if(ia > ca){ bh2 = workH; bw2 = workH * ia; }
      else{ bw2 = workW; bh2 = workW / ia; }
      var dw = bw2 * st.scale, dh = bh2 * st.scale;
      var mox = Math.max(0, (dw - workW) / 2);
      var moy = Math.max(0, (dh - workH) / 2);
      var ox = Math.max(-mox, Math.min(mox, st.ox * scale));
      var oy = Math.max(-moy, Math.min(moy, st.oy * scale));
      var imgX = outer + workW / 2 - dw / 2 + ox;
      var imgY = outer + workH / 2 - dh / 2 + oy;

      S.panels.forEach(function(p){
        var r = panelPxRect(p, cW, cH, outer, gutter, line);
        if(r.iw <= 0 || r.ih <= 0) return;
        tc.save();
        tc.beginPath();
        tc.rect(r.ix, r.iy, r.iw, r.ih);
        tc.clip();
        tc.drawImage(img, imgX, imgY, dw, dh);
        tc.restore();

        /* Panel border - same color as frame */
        if(line > 0){
          tc.strokeStyle = frameColor;
          tc.lineWidth = line;
          tc.strokeRect(r.rx + line / 2, r.ry + line / 2, r.rw - line, r.rh - line);
        }
      });
    } else {
      /* No image: numbered placeholders */
      S.panels.forEach(function(p, idx){
        var r = panelPxRect(p, cW, cH, outer, gutter, line);
        /* Placeholder background (subtle contrast for visibility) */
        tc.fillStyle = placeholderBg;
        tc.fillRect(r.ix, r.iy, r.iw, r.ih);
        /* Panel number */
        tc.fillStyle = placeholderFg;
        var fs = Math.min(r.iw, r.ih) * 0.18;
        tc.font = '600 ' + fs + 'px Inter';
        tc.textAlign = 'center';
        tc.textBaseline = 'middle';
        tc.fillText(String(idx + 1), r.ix + r.iw / 2, r.iy + r.ih / 2);

        /* Panel border */
        if(line > 0){
          tc.strokeStyle = frameColor;
          tc.lineWidth = line;
          tc.strokeRect(r.rx + line / 2, r.ry + line / 2, r.rw - line, r.rh - line);
        }
      });
    }
  } else {
    /* Individual mode */
    S.panels.forEach(function(p, idx){
      var r = panelPxRect(p, cW, cH, outer, gutter, line);
      if(r.iw <= 0 || r.ih <= 0) return;
      var img = S.pImages[p.id];

      if(img){
        var st = S.pState[p.id] || {ox:0, oy:0, scale:1};
        tc.save();
        tc.beginPath();
        tc.rect(r.ix, r.iy, r.iw, r.ih);
        tc.clip();
        drawCover(tc, img, r.ix, r.iy, r.iw, r.ih, st.ox * scale, st.oy * scale, st.scale);
        tc.restore();
      } else {
        /* Placeholder */
        tc.fillStyle = placeholderBg;
        tc.fillRect(r.ix, r.iy, r.iw, r.ih);
        tc.fillStyle = placeholderFg;
        var fs = Math.min(r.iw, r.ih) * 0.18;
        tc.font = '600 ' + fs + 'px Inter';
        tc.textAlign = 'center';
        tc.textBaseline = 'middle';
        tc.fillText(String(idx + 1), r.ix + r.iw / 2, r.iy + r.ih / 2);
      }

      /* Panel border */
      if(line > 0){
        tc.strokeStyle = frameColor;
        tc.lineWidth = line;
        tc.strokeRect(r.rx + line / 2, r.ry + line / 2, r.rw - line, r.rh - line);
      }
    });
  }

  /* Outer border - same color as frame */
  if(outer > 0){
    tc.strokeStyle = frameColor;
    tc.lineWidth = outer;
    tc.strokeRect(outer / 2, outer / 2, cW - outer, cH - outer);
  }
}

function render(){
  renderCore(mCtx, mCanvas, 1);
  fitCanvas();
  updateEmptyState();
}

function updateOverlay(){
  var dims = getCanvasDims();
  var outer = OUTER_MAP[S.outerKey];
  var gutter = GUTTER_MAP[S.gutterKey];
  var line = LINE_MAP[S.lineKey];
  oCtx.clearRect(0, 0, oCanvas.width, oCanvas.height);

  if(S.activeId >= 0 && S.mode === 'indiv'){
    var p = getPanelById(S.activeId);
    if(p){
      var r = panelPxRect(p, dims.w, dims.h, outer, gutter, line);
      oCtx.strokeStyle = 'rgba(51,51,51,0.7)';
      oCtx.lineWidth = 2.5;
      oCtx.setLineDash([]);
      oCtx.strokeRect(r.ix + 1, r.iy + 1, r.iw - 2, r.ih - 2);
    }
  }

  if(S.tool === 'pen' && S.iMode === 'draw' && S.drawEnd && S.iPanelId >= 0){
    var p2 = getPanelById(S.iPanelId);
    if(p2){
      var r2 = panelPxRect(p2, dims.w, dims.h, outer, gutter, line);
      var x1 = S.iStart.cx, y1 = S.iStart.cy;
      var x2 = S.drawEnd.cx, y2 = S.drawEnd.cy;
      var ddx = Math.abs(x2 - x1), ddy = Math.abs(y2 - y1);
      var isH = ddx > ddy;
      var midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;

      var lx1, ly1, lx2, ly2;
      if(isH){
        var sy = Math.max(r2.iy + r2.ih * MIN_RATIO, Math.min(r2.iy + r2.ih * (1 - MIN_RATIO), midY));
        lx1 = r2.ix; ly1 = sy; lx2 = r2.ix + r2.iw; ly2 = sy;
      } else {
        var sx = Math.max(r2.ix + r2.iw * MIN_RATIO, Math.min(r2.ix + r2.iw * (1 - MIN_RATIO), midX));
        lx1 = sx; ly1 = r2.iy; lx2 = sx; ly2 = r2.iy + r2.ih;
      }

      oCtx.fillStyle = 'rgba(0,102,204,0.08)';
      oCtx.fillRect(r2.ix, r2.iy, r2.iw, r2.ih);

      oCtx.save();
      oCtx.strokeStyle = 'rgba(0,102,204,0.9)';
      oCtx.lineWidth = 2;
      oCtx.setLineDash([6, 4]);
      oCtx.beginPath();
      oCtx.moveTo(lx1, ly1);
      oCtx.lineTo(lx2, ly2);
      oCtx.stroke();
      oCtx.restore();
    }
  }
}

function updateEmptyState(){
  var hasContent = S.splitImg || Object.keys(S.pImages).length > 0;
  emptyEl.style.display = hasContent ? 'none' : 'block';
}

/* ==========================================================
   TOUCH / MOUSE HANDLERS
========================================================== */
mCanvas.addEventListener('touchstart', onTStart, {passive:false});
mCanvas.addEventListener('touchmove', onTMove, {passive:false});
mCanvas.addEventListener('touchend', onTEnd, {passive:false});
mCanvas.addEventListener('touchcancel', onTEnd, {passive:false});

mCanvas.addEventListener('mousedown', onMDown);
window.addEventListener('mousemove', onMMove);
window.addEventListener('mouseup', onMUp);
mCanvas.addEventListener('mousemove', function(e){
  if(S.iMode) return;
  var pt = toCanvas(e.clientX, e.clientY);
  var p = getPanelAt(pt.cx, pt.cy);
  mCanvas.style.cursor = S.tool === 'pen' ? 'crosshair' : (p ? 'grab' : 'default');
});

function onTStart(e){
  e.preventDefault();
  var t0 = e.touches[0];
  var pt = toCanvas(t0.clientX, t0.clientY);

  if(e.touches.length === 2){
    var panel = null;
    if(S.mode === 'indiv') panel = getPanelById(S.activeId);
    var mid = toCanvas((e.touches[0].clientX + e.touches[1].clientX) / 2,
                       (e.touches[0].clientY + e.touches[1].clientY) / 2);
    S.iMode = 'pinch';
    S.iStart = mid;
    S.iStartDist = touchDist(e.touches);
    if(S.mode === 'split'){
      S.iStartSc = S.splitSt.scale;
      S.iStartOff = {ox:S.splitSt.ox, oy:S.splitSt.oy};
    } else if(panel){
      var cs = S.pState[panel.id] || {ox:0, oy:0, scale:1};
      S.iStartSc = cs.scale;
      S.iStartOff = {ox:cs.ox, oy:cs.oy};
      S.iPanelId = panel.id;
    }
    return;
  }

  if(S.tool === 'pen'){
    var p = getPanelAt(pt.cx, pt.cy);
    if(!p) return;
    S.iMode = 'draw';
    S.iPanelId = p.id;
    S.iStart = {cx:pt.cx, cy:pt.cy};
    S.drawEnd = {cx:pt.cx, cy:pt.cy};
    updateOverlay();
  } else {
    startPan(pt.cx, pt.cy);
  }
}

function onTMove(e){
  e.preventDefault();
  if(!S.iMode) return;
  var t0 = e.touches[0];

  if(S.iMode === 'pinch' && e.touches.length === 2){
    var d = touchDist(e.touches);
    var ratio = d / S.iStartDist;
    var mid = toCanvas((e.touches[0].clientX + e.touches[1].clientX) / 2,
                       (e.touches[0].clientY + e.touches[1].clientY) / 2);
    applyPinch(ratio, mid.cx - S.iStart.cx, mid.cy - S.iStart.cy);
    render();
    updateOverlay();
    return;
  }

  var pt = toCanvas(t0.clientX, t0.clientY);

  if(S.iMode === 'draw'){
    S.drawEnd = {cx:pt.cx, cy:pt.cy};
    updateOverlay();
  } else if(S.iMode === 'pan'){
    applyPan(pt.cx, pt.cy);
    render();
    updateOverlay();
  }
}

function onTEnd(e){
  e.preventDefault();
  if(S.iMode === 'draw'){
    finishDraw();
  }
  if(e.touches.length === 0) S.iMode = null;
}

function onMDown(e){
  if(e.button !== 0) return;
  var pt = toCanvas(e.clientX, e.clientY);
  if(S.tool === 'pen'){
    var p = getPanelAt(pt.cx, pt.cy);
    if(!p) return;
    S.iMode = 'draw';
    S.iPanelId = p.id;
    S.iStart = {cx:pt.cx, cy:pt.cy};
    S.drawEnd = {cx:pt.cx, cy:pt.cy};
    updateOverlay();
  } else {
    startPan(pt.cx, pt.cy);
  }
  e.preventDefault();
}

function onMMove(e){
  if(!S.iMode) return;
  var pt = toCanvas(e.clientX, e.clientY);
  if(S.iMode === 'draw'){
    S.drawEnd = {cx:pt.cx, cy:pt.cy};
    updateOverlay();
  } else if(S.iMode === 'pan'){
    applyPan(pt.cx, pt.cy);
    render();
    updateOverlay();
  }
}

function onMUp(e){
  if(S.iMode === 'draw') finishDraw();
  S.iMode = null;
  mCanvas.style.cursor = S.tool === 'pen' ? 'crosshair' : 'default';
}

function startPan(cx, cy){
  var p = null;
  if(S.mode === 'indiv'){
    p = getPanelAt(cx, cy);
    if(!p){ setActiveId(-1); return; }
    setActiveId(p.id);
    if(!S.pImages[p.id]) return;
    S.iPanelId = p.id;
    var cs = S.pState[p.id] || {ox:0, oy:0, scale:1};
    S.iStartOff = {ox:cs.ox, oy:cs.oy};
  } else {
    if(!S.splitImg) return;
    S.iPanelId = -1;
    S.iStartOff = {ox:S.splitSt.ox, oy:S.splitSt.oy};
  }
  S.iMode = 'pan';
  S.iStart = {cx:cx, cy:cy};
  mCanvas.style.cursor = 'grabbing';
}

function applyPan(cx, cy){
  var ddx = cx - S.iStart.cx, ddy = cy - S.iStart.cy;
  if(S.iPanelId < 0){
    S.splitSt.ox = S.iStartOff.ox + ddx;
    S.splitSt.oy = S.iStartOff.oy + ddy;
  } else {
    if(!S.pState[S.iPanelId]) S.pState[S.iPanelId] = {ox:0, oy:0, scale:1};
    S.pState[S.iPanelId].ox = S.iStartOff.ox + ddx;
    S.pState[S.iPanelId].oy = S.iStartOff.oy + ddy;
  }
}

function applyPinch(ratio, panDx, panDy){
  var newSc = Math.max(1, Math.min(5, S.iStartSc * ratio));
  if(S.iPanelId < 0){
    S.splitSt.scale = newSc;
    S.splitSt.ox = S.iStartOff.ox + panDx;
    S.splitSt.oy = S.iStartOff.oy + panDy;
  } else if(S.iPanelId >= 0){
    if(!S.pState[S.iPanelId]) S.pState[S.iPanelId] = {ox:0, oy:0, scale:1};
    S.pState[S.iPanelId].scale = newSc;
    S.pState[S.iPanelId].ox = S.iStartOff.ox + panDx;
    S.pState[S.iPanelId].oy = S.iStartOff.oy + panDy;
  }
}

function finishDraw(){
  if(!S.drawEnd || S.iPanelId < 0){
    S.drawEnd = null;
    updateOverlay();
    return;
  }
  var dx = S.drawEnd.cx - S.iStart.cx;
  var dy = S.drawEnd.cy - S.iStart.cy;
  var dist = Math.sqrt(dx * dx + dy * dy);
  if(dist < PEN_THRESH){
    setActiveId(S.iPanelId);
    S.drawEnd = null;
    updateOverlay();
    return;
  }
  pushHistory();
  splitPanel(S.iPanelId, S.iStart.cx, S.iStart.cy, S.drawEnd.cx, S.drawEnd.cy);
  S.drawEnd = null;
  syncUndoBtn();
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

/* ==========================================================
   ACTIVE PANEL
========================================================== */
function setActiveId(id){
  S.activeId = id;
  updateOverlay();
  refreshCellGrid();
  updateCellZoomPanel();
}

function updateCellZoomPanel(){
  var zp = document.getElementById('zPanelCell');
  if(!zp) return;
  if(S.mode !== 'indiv' || S.activeId < 0){
    zp.style.display = 'none';
    return;
  }
  var cs = S.pState[S.activeId] || {ox:0, oy:0, scale:1};
  document.getElementById('zCellLbl').textContent = 'Panel ' + (panelDisplayIdx(S.activeId) + 1) + ' Zoom';
  var sldr = document.getElementById('zCell');
  sldr.value = Math.round(cs.scale * 100);
  document.getElementById('zCellVal').textContent = cs.scale.toFixed(1) + 'x';
  zp.style.display = 'block';
}

function panelDisplayIdx(id){
  for(var i = 0; i < S.panels.length; i++)
    if(S.panels[i].id === id) return i;
  return 0;
}

/* ==========================================================
   FILE UPLOAD
========================================================== */
var uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', function(e){ e.preventDefault(); e.stopPropagation(); uploadZone.classList.add('drag'); });
uploadZone.addEventListener('dragleave', function(e){ e.stopPropagation(); uploadZone.classList.remove('drag'); });
uploadZone.addEventListener('drop', function(e){
  e.preventDefault();
  e.stopPropagation();
  uploadZone.classList.remove('drag');
  if(e.dataTransfer && e.dataTransfer.files.length > 0)
    loadSplitFile(e.dataTransfer.files[0]);
});
fInput.addEventListener('change', function(){
  if(fInput.files && fInput.files.length > 0)
    loadSplitFile(fInput.files[0]);
});
fInputCell.addEventListener('change', function(){
  if(fInputCell.files && fInputCell.files.length > 0 && S.pendCell >= 0){
    loadCellFile(fInputCell.files[0], S.pendCell);
  }
});

function loadSplitFile(file){
  if(!file.type.startsWith('image/')) return;
  readImg(file, function(img){
    S.splitImg = img;
    S.splitSt = {ox:0, oy:0, scale:1};
    document.getElementById('zPanelSplit').style.display = 'block';
    document.getElementById('zGlobal').value = 100;
    document.getElementById('zGlobalVal').textContent = '1.0x';
    updateSaveBtn();
    if(!S.hintShown){
      S.hintShown = true;
      showToast('Drag to adjust position / Pinch to zoom');
    }
    requestAnimationFrame(function(){ render(); updateOverlay(); });
    fInput.value = '';
  });
}

function loadCellFile(file, panelId){
  if(!file.type.startsWith('image/')) return;
  readImg(file, function(img){
    S.pImages[panelId] = img;
    S.pState[panelId] = {ox:0, oy:0, scale:1};
    setActiveId(panelId);
    refreshCellGrid();
    updateSaveBtn();
    if(!S.hintShown){
      S.hintShown = true;
      showToast('Drag to adjust / Pinch to zoom');
    }
    requestAnimationFrame(function(){ render(); updateOverlay(); });
    fInputCell.value = '';
  });
}

function readImg(file, cb){
  var img = new Image();
  img.onload = function(){ cb(img); };
  img.onerror = function(){ console.warn('ComicFrame: load error', file.name); };
  img.src = URL.createObjectURL(file);
}

/* ==========================================================
   CELL GRID
========================================================== */
function refreshCellGrid(){
  var grid = document.getElementById('cellGrid');
  if(!grid) return;
  grid.innerHTML = '';
  S.panels.forEach(function(p, i){
    var slot = document.createElement('div');
    var hasPic = !!S.pImages[p.id];
    var isSel = p.id === S.activeId;
    slot.className = 'cslot' + (hasPic ? ' has' : '') + (isSel ? ' sel' : '');
    if(hasPic){
      var thumb = document.createElement('img');
      thumb.src = S.pImages[p.id].src;
      slot.appendChild(thumb);
    }
    var lbl = document.createElement('span');
    lbl.textContent = 'P' + (i + 1);
    slot.appendChild(lbl);
    slot.onclick = (function(pid){ return function(){
      S.pendCell = pid;
      setActiveId(pid);
      fInputCell.click();
    }; })(p.id);
    grid.appendChild(slot);
  });
  updateCellZoomPanel();
}

/* ==========================================================
   ZOOM CONTROLS
========================================================== */
function onZoomGlobal(v){
  S.splitSt.scale = parseInt(v) / 100;
  document.getElementById('zGlobalVal').textContent = S.splitSt.scale.toFixed(1) + 'x';
  requestAnimationFrame(function(){ render(); });
}
function resetGlobal(){
  S.splitSt = {ox:0, oy:0, scale:1};
  document.getElementById('zGlobal').value = 100;
  document.getElementById('zGlobalVal').textContent = '1.0x';
  requestAnimationFrame(function(){ render(); });
}

function onZoomCell(v){
  if(S.activeId < 0) return;
  if(!S.pState[S.activeId]) S.pState[S.activeId] = {ox:0, oy:0, scale:1};
  S.pState[S.activeId].scale = parseInt(v) / 100;
  document.getElementById('zCellVal').textContent = S.pState[S.activeId].scale.toFixed(1) + 'x';
  requestAnimationFrame(function(){ render(); });
}
function resetActiveCell(){
  if(S.activeId < 0) return;
  S.pState[S.activeId] = {ox:0, oy:0, scale:1};
  document.getElementById('zCell').value = 100;
  document.getElementById('zCellVal').textContent = '1.0x';
  requestAnimationFrame(function(){ render(); });
}
function clearActiveCell(){
  if(S.activeId < 0) return;
  delete S.pImages[S.activeId];
  S.pState[S.activeId] = {ox:0, oy:0, scale:1};
  refreshCellGrid();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

/* ==========================================================
   SETTINGS
========================================================== */
function setTool(t){
  S.tool = t;
  document.getElementById('btnSelect').classList.toggle('on', t === 'select');
  document.getElementById('btnPen').classList.toggle('on', false);
  document.getElementById('btnPen').classList.toggle('pen-on', t === 'pen');
  mCanvas.style.cursor = t === 'pen' ? 'crosshair' : 'default';
  if(t === 'pen'){
    penBadge.classList.add('show');
    clearTimeout(penBadgeTimer);
    penBadgeTimer = setTimeout(function(){ penBadge.classList.remove('show'); }, 3000);
  } else {
    penBadge.classList.remove('show');
  }
}

function setMode(m){
  S.mode = m;
  document.getElementById('btnMSplit').classList.toggle('on', m === 'split');
  document.getElementById('btnMIndiv').classList.toggle('on', m === 'indiv');
  document.getElementById('pSplit').style.display = m === 'split' ? 'block' : 'none';
  document.getElementById('pIndiv').style.display = m === 'indiv' ? 'block' : 'none';
  if(m === 'indiv') refreshCellGrid();
  S.activeId = -1;
  updateOverlay();
  updateSaveBtn();
  requestAnimationFrame(function(){ render(); });
}

function setFrameColor(c){
  S.frameColor = c;
  document.getElementById('fc-black').classList.toggle('on', c === 'black');
  document.getElementById('fc-white').classList.toggle('on', c === 'white');
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function setOuter(k){
  S.outerKey = k;
  ['none', 'thin', 'mid', 'thick'].forEach(function(id){
    document.getElementById('ob-' + id).classList.toggle('on', id === k);
  });
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function setGutter(k){
  S.gutterKey = k;
  ['none', 'narrow', 'mid', 'wide'].forEach(function(id){
    document.getElementById('gu-' + id).classList.toggle('on', id === k);
  });
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function setLine(k){
  S.lineKey = k;
  ['none', 'thin', 'mid', 'thick'].forEach(function(id){
    document.getElementById('lw-' + id).classList.toggle('on', id === k);
  });
  requestAnimationFrame(function(){ render(); updateOverlay(); });
}

function setQuality(q){
  S.quality = q;
  ['std', 'hi'].forEach(function(id){
    document.getElementById('q-' + id).classList.toggle('on', id === q);
  });
}

function updateSaveBtn(){
  var hasContent = S.splitImg || Object.keys(S.pImages).length > 0;
  btnSave.disabled = !hasContent;
}

/* ==========================================================
   TABS
========================================================== */
function switchTab(id){
  document.querySelectorAll('.tab').forEach(function(t){
    t.classList.toggle('on', t.getAttribute('data-tc') === id);
  });
  document.querySelectorAll('.tc').forEach(function(c){
    c.classList.toggle('on', c.id === id);
  });
}

/* ==========================================================
   TOASTS
========================================================== */
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ toastEl.classList.remove('show'); }, 3000);
}

/* ==========================================================
   EXPORT / SHARE
========================================================== */
function saveImage(){
  var scale = QUAL_MAP[S.quality];
  var offCanvas = document.createElement('canvas');
  var offCtx = offCanvas.getContext('2d');
  renderCore(offCtx, offCanvas, scale);

  offCanvas.toBlob(function(blob){
    if(!blob) return;
    var file = new File([blob], 'comicframe.png', {type:'image/png'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({
        title:'ComicFrame',
        files:[file]
      }).catch(function(err){
        if(err.name !== 'AbortError') fallbackDL(blob);
      });
    } else {
      fallbackDL(blob);
    }
  }, 'image/png');
}

function fallbackDL(blob){
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'comicframe_' + Date.now() + '.png';
  a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
}

/* ==========================================================
   BOOT
========================================================== */
render();
updateOverlay();
updateSaveBtn();
</script>
</body>
</html>
